<html><head></head><body><div hidden="" by-polymer-bundler=""><link rel="import" href="../epiviz-imports/epiviz-common-css.html"><link rel="import" href="../epiviz-imports/epiviz-common-js.html"><link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">


<dom-module id="shared-settings">
  <template>
    <style>
        #chartSettingsContainer {
            /*float: right;*/
            position:absolute;
            top: 0;
            right: 0;
            /*width: 24px;
            height: 24px;*/
            
            /*--iron-icon-height: 16px;
            --iron-icon-width: 16px;*/

            border: 1px solid #000;
            border-radius: 2px;
            margin:1px;
            /*background-color: #fff000;*/
        }

        #chartSettingsIcon {
            float: right;
            width: 24px;
            height: 24px;
            padding: 1px;
        }

        #chartColorsIcon {
            float: right;
            width: 24px;
            height: 24px;
            padding: 2px;
        }
    </style>
  </template>
</dom-module>


<script>
    /**
     * `ChartBehavior` is an interface to all epiviz-charts. 
     * all charts inherit this behavior.
     *
     * @polymerBehavior
    **/
    epiviz.ChartBehavior = {
        properties : {

            /**
             * Dimensions for a chart. (x and y axis measurements).
             *
             * @type {Array<string>}
             */            
            dimS: {
                type: Array,
                notify: true
            },

            /**
             * Whether to use a default data provider. only for testing & development. 
             *
             * @type {boolean}
             */   
            useDefaultDataProvider: {
                type: Boolean,
                notify: true
            },

            /**
             * Chart data object.
             *
             * @type {Object<epiviz.datatypes.MapGenomicData>}
             */   
            data: {
                type: Object,
                notify: true,
                observer: '_dataChanged'
            },

            /**
             * Unique chart Id
             *
             * @type {string}
             */   
            plotId: {
                type: String,
                reflectToAttribute: true,
                notify: true
            },

            /**
             * Measurements for the chart. Charts automatically sets measurements from `dimS`.
             *
             * @type {Array<Object>}
             */   
            measurements: {
                type: Array,
                notify: true,
                observer: '_measurementsChanged'
            },

            /**
             * Computed Range from `<chr>`, `<start>` & `<end>`. 
             *
             * @type {Object<epiviz.datatypes.GenomicRange>}
             */
            range: {
                type: Object,
                notify: true,
                observer: '_rangeChanged'
            },

            /**
             * Chart Settings. 
             *
             * @type {Array.<epiviz.ui.charts.CustomSetting>}
             */
            chartSettings: {
                type: Object,
                notify: true,
                observer: '_chartSettingsChanged'
            },

            /**
             * Chart Colors. 
             *
             * @type {Array<epiviz.ui.charts.ColorPalette>}
             */
            chartColors: {
                type: Array,
                notify: true,
                observer: '_chartColorsChanged'
            }
        },

        observers: [
            '_dimChanged(dimX.*, dimY.*, dimS.*)'
        ],

        listeners: {
            'iron-resize': '_onResize',
            'transitionend': '_onResize'
        },

        // onElementResize: function(event) {
        //     console.log(event);
        // },

        /**
         * Resizes the chart.
         */
        _onResize: function() {
            var self = this;
            // this._measurementsChanged();
            if(this.chart != null) {
                // var width = self.offsetWidth - 40;
                // if(width < self.chartType.defaultWidth()) { width = self.chartType.defaultWidth()}
                this.chart._properties.width = self.offsetWidth - 20 - epiviz.ui.charts.Visualization.SVG_MARGIN;
                this.chart._properties.height = self.offsetHeight - 20 - epiviz.ui.charts.Visualization.SVG_MARGIN;
                self._dataChanged();
            }
        },

        /**
         * Generates a unique chart ID
         * 
         * @return {string}
         */
        _generatePlotId: function() {
            var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            var result = '';
            var size = 7;

            for (var i = 0; i < size; ++i) {
                result += chars[Math.round(Math.random() * (chars.length - 1))];
            }
            return 'epiviz-' + result;
        },


        /**
         * MeasurementChange/ChartDimension event handler.
         * Listens to when a chart dimensions(axes) are changed and updates chart
         *
         * @fires dimChanged
         */
        _dimChanged: function() {

            /**
             * fires event when a chart dimensions are changed.
             *
             * @event dimChanged
             * @type {string}
             * @property {string} id - Id of the chart element.
             */
            $('#' + this.plotId).empty();
            this.fire('dimChanged', {
                id: this.plotId
            });
        },

        /**
         * chartSettings change event handler.
         */
        _chartSettingsChanged: function() {
            var self = this;
            self.chart.setCustomSettingsValues(self.chartSettings);
            // self._dataChanged();
        },

        /**
         * chartColors change event handler.
         */
        _chartColorsChanged: function() {
            var self = this;
            self.chartColorPalette = new epiviz.ui.charts.ColorPalette(self.chartColors);
            self.chart.setColors(self.chartColorPalette);
            self._dataChanged();
        },

        /**
         * ChartLocation/RangeChange event handler.
         */
        _rangeChanged: function() {
            this._measurementsChanged();
        },

        /**
         * MeasurementChange/ChartDimension event handler.
         * Listens to when a chart dimensions(axes) are changed and updates chart
         */
        _measurementsChanged: function() {

            var self = this;

            if (this.measurements != null && self.config != null) {

                $('#' + self.plotId).empty();
                var mSet = new epiviz.measurements.MeasurementSet();

                for (var i = 0; i < self.measurements.length; i++) {

                    var measurement = self.measurements[i];
                    mSet.add(new epiviz.measurements.Measurement(
                        measurement.id,
                        measurement.name,
                        measurement.type,
                        measurement.datasourceId,
                        measurement.datasourceGroup,
                        measurement.dataprovider,
                        measurement.formula,
                        measurement.defaultChartType,
                        measurement.annotation,
                        measurement.minValue,
                        measurement.maxValue,
                        measurement.metadata
                    ));
                }

                self.visConfigSelection = new epiviz.ui.controls.VisConfigSelection(mSet);
                // self.chartType = new epiviz.plugins.charts.LineTrackType(self.config);
                self.chartType = self._createChart();

                var width = self.offsetWidth - 40;
                if(width < self.chartType.defaultWidth()) { width = self.chartType.defaultWidth()}

                if(self.chartType) {
                    self.chartProperties = new epiviz.ui.charts.VisualizationProperties(
                        width,
                        self.chartType.defaultHeight(),
                        self.chartType.defaultMargins(),
                        self.visConfigSelection,
                        self.chartType.defaultColors(),
                        null,
                        self.chartType.customSettingsValues(),
                        self.chartType.customSettingsDefs(), [],
                        null
                    );

                    self.chart = self.chartType.createNew(self.plotId, $('#' + self.plotId), self.chartProperties);

                    if(self.chartSettings != null || self.chartSettings != undefined) {
                        self.chart.setCustomSettingsValues(self.chartSettings);
                    }
                    else {
                        self.chartSettings = self.chart._customSettingsValues;
                    }

                    if(self.chartColors != null || self.chartColors != undefined) {
                        self.chartColorPalette = new epiviz.ui.charts.ColorPalette(self.chartColors);
                        self.chart.setColors(self.chartColorPalette);
                    }
                    else {
                        self.chartColorPalette = self.chart.colors();
                        self.chartColors = self.chartColorPalette._colors;
                    }

                    self._initializeSettingsContainer();

                    self._initializeSettingsDialog();
                    self._initializeColorsDialog();

                    // Listen to hover event on the chart
                    /**
                     * fires event when a chart data object is hovered.
                     *
                     * @event hover
                     * @type {object}
                     * @property {object} data - data object currently hovered.
                     */
                    self.chart.onHover().addListener(new epiviz.events.EventListener(
                        function(e) {
                            var id = e.id;
                            var data = e.args;
                            self.hover(data);
                            self.fire('hover', {
                                id: id,
                                data: data
                            });
                        }
                    ));

                    /**
                     * fires event when a chart data object is unhovered.
                     *
                     * @event unHover
                     * @type {object}
                     * @property {object} data - data object currently hovered.
                     */
                    self.chart.onUnhover().addListener(new epiviz.events.EventListener(
                        function(e) {
                            var id = e.id;
                            var data = e.args;
                            self.unHover();
                            self.fire('unHover', {
                                id: id
                            });
                        }
                    ));

                    if (self.useDefaultDataProvider) {

                        self.measurements = self.measurements || [{
                            'id': 'genes',
                            'name': 'Genes',
                            'type': 'range',
                            'datasourceId': 'genes',
                            'datasourceGroup': 'genes',
                            'dataprovider': 'umd',
                            'formula': null,
                            'defaultChartType': "Genes Track",
                            'annotation': null,
                            'minValue': null,
                            'maxValue': null,
                            'metadata': ['gene', 'entrez', 'exon_starts', 'exon_ends']
                        }];

                        self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);
                        var chartMeasMap = {};
                        chartMeasMap[self.plotId] = self.visConfigSelection.measurements;
                        var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                        var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                        dataManager.getData(self.range, chartMeasMap, function(id, data) {
                            self.data = data;
                        });
                    }
                }
            }
        },

        /**
         * ChartData change event handler.
         */
        _dataChanged: function() {
            if (this.data != null && this.chart != null) {
                this._draw();
            }
        },

        /**
         * Hover event handler.
         *
         * @param {object} data data object currently hovered.
         */
        hover: function(data) {
            this.chart.doHover(data);
        },

        /**
         * unHover event handler.
         */
        unHover: function() {
            this.chart.doUnhover();
        },

        /**
         * Intilizes chart container DOM element for settings and colors elements.
         */
        _initializeSettingsContainer: function() {
            var chartContainer = this.$$('#' + this.plotId);
            var settingsContainer = this.$$('#' + this.plotId + '-chartSettingsContainer');

            if(settingsContainer == null) {
                var iconElem = document.createElement('div');
                iconElem.hidden = true;
                iconElem.id = "chartSettingsContainer";

                // iconElem.addEventListener("click", this._showColorsDialog.bind(this));
                Polymer.dom(chartContainer).appendChild(iconElem);
            }
        },

        /**
         * Handles when mouse-overed on a chart to show settings and colors.
         */
        hostHovered: function() {
            var currColorsIcon = this.$$('#chartSettingsContainer');
            if(currColorsIcon) {
                currColorsIcon.hidden = false;
            }
        },

        /**
         * Handles when mouse-overed on a chart to show settings and colors.
         */
        hostUnhovered: function() {
            var currColorsIcon = this.$$('#chartSettingsContainer');
            if(currColorsIcon) {
                currColorsIcon.setAttribute("hidden", true);   
            }
        }
    }
</script><script>
    /**
     * `ChartDataBehavior` object handles data requests from all epiviz-charts. 
     * `<epiviz-environment>` & `<epiviz-navigation>` automatically inherit this behavior to update chart data.
     *
     * @polymerBehavior
    **/
    epiviz.ChartDataBehavior = {

        properties: {
            /**
             * Whether to apply a data transformation function
             *
             * @type {boolean}
             */
            transformData: {
                type: Boolean,
                notify: true,
                value: false
            },

            /**
             * Data Transformation function
             *
             * @type {string}
             */
            transformDataFunc: {
                type: String,
                notify: true
            }
        },

        /* callback called when the behavior is created.*/
        created: function() {        
            var dataManagerElem = document.querySelector('epiviz-data-source');
            if(dataManagerElem) {
                this.dataManager = new epiviz.data.DataManager(dataManagerElem.config, dataManagerElem.dataProviderFactory);
            }
        },

        /**
         *  output data format 
         *  {
         *      columns: Collection <Object> {measurement-id: <Epiviz measurement>}
         *      values : Array  [measurement-id: Val <Integer>, row: rowInfo]
         *  }
         * TODO: json structure
         *
         * @param {Object} data data object
         *
         * @return {Object} transformed data object
         */
        epivizToJSON: function(data) {

            if(!this.transformData) {
                return data;
            }

            var fromDataMeasurements = [];
            var range = this.range;

            var firstGlobalIndex = data.firstSeries().globalStartIndex();
            var lastGlobalIndex = data.firstSeries().globalEndIndex();

            data.foreach(function(measurement, series) {
                fromDataMeasurements.push(measurement);
                var firstIndex = series.globalStartIndex();
                var lastIndex = series.globalEndIndex();
                if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
                if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
            });

            var nItems = lastGlobalIndex - firstGlobalIndex;

            var i, index;
            var grid = {};
            grid.measurements = fromDataMeasurements;
            grid.columns = {};

            grid.measurements.forEach(function(m) {
                grid.columns[m.datasourceId() + "-" + m.id()] = m;
            });

            grid.values = [];
            var nSeries = fromDataMeasurements.length;
            for (i = 0; i < nItems; ++i) {
                index = i + firstGlobalIndex;
                var valArray = {};
                
                var row = {};
                var rowData = data.getSeries(fromDataMeasurements[0]).getRowByGlobalIndex(index);
                row.start = rowData.start();
                row.end = rowData.end();
                row.metadata = rowData.rowMetadata();
                row.strand = rowData.strand();
                row.index = rowData.index();
                row.globalIndex = rowData.globalIndex();
                row.id = rowData.id();
                row.seqName = rowData.seqName();
                valArray.row = row;

                grid.measurements.forEach(function(m) {
                    var cellX = data.getSeries(m).getByGlobalIndex(index);
                    valArray[m.datasourceId() + "-" + m.id()] = cellX.value;
                });

                grid.values.push(valArray);
            }
            return grid;
        },

        /**
         * Handles search requests for genes
         * 
         * @param {string} gene keyword to search for genes
         * @param {HTMLElement} currentChild child HTML element where request was created
         * @param {HTMLElement} pDom parent HTML element of the child 
         * @callback cb
         * @param {cb} cb Callback that handles the response
         */
        _getElementSearch: function(gene, currentChild, pDom, cb) {

            // var dataManagerElem = document.querySelector('epiviz-data-source');

            // if (dataManagerElem != null) {
            //     var dataManager = dataManagerElem.dataManager;
            if(this.dataManager) {
                this.dataManager.search(function(data) {
                    if(pDom) {
                        pDom.$$("#geneSearch").suggestions(data);
                    }
                    else {
                        cb(data);
                    }
                }, gene);
            }
        },

        /**
         * Handles gene in range requests.
         * Given a range, get the gene close to the center of the given location.
         * 
         * @param {HTMLElement} currentChild child HTML element where request was created
         * @param {HTMLElement} pDom parent HTML element of the child 
         */
        _getGenesInRange: function(currentChild, pDom) {
            var self = this;

            var mSet = new epiviz.measurements.MeasurementSet();
            var m = new epiviz.measurements.Measurement(
                "genes",
                "Genes",
                "range",
                "genes",
                "genes",
                "umd",
                null,
                "Genes Track",
                null,
                null,
                null,
                ["gene", "entrez", "exon_starts", "exon_ends"]
            )
            mSet.add(m);

            var chartMeasMap = {};
            chartMeasMap[currentChild.plotId] = mSet;

            if(this.dataManager) {
                this.dataManager.getData(currentChild.range, chartMeasMap, function(id, data) {
                    // Get gene (based on size)
                    // var index = data.globalStartIndex(m) + Math.round((data.size(m) - 1) / 2);

                    // Get gene (based on position)
                    var searchIndex = data.binarySearchStarts(m, new epiviz.datatypes.GenomicRange(pDom.range.seqName(), (pDom.range.start() + pDom.range.end()) / 2, 1000000));
                    var index = data.globalStartIndex(m) + searchIndex.index;
                    
                    var gene = data.getRowByGlobalIndex(m, index).rowMetadata().gene;

                    pDom.geneInRange = gene;
                });
            }
        },

        /**
         * Handles SeqInfo requests
         * 
         * @param {HTMLElement} currentChild child HTML element where request was created
         * @param {HTMLElement} pDom parent HTML element of the child 
         */
        _getElementSeqInfo: function(currentChild, pDom) {

            // var dataManagerElem = document.querySelector('epiviz-data-source');
            if(this.dataManager) {
            //     var dataManager = dataManagerElem.dataManager;
                this.dataManager.getSeqInfos(function(data) {
                    var seqinfo = {};
                    data.forEach(function(s) {
                        seqinfo[s.seqName] = s;
                    });
                    currentChild.seqInfo = seqinfo;
                });
            }
        },

        /**
         * Handles data requests
         * 
         * @param {HTMLElement} currentChild child HTML element where request was created
         * @param {HTMLElement} pDom parent HTML element of the child 
         * @param {Array<string>} measurements measurements to request data 
         */
        _getElementData: function(currentChild, pDom, measurements) {
            var self = this;

            if(self.dataManager != null) {
            var dims = currentChild.dimS || currentChild.getAttribute("dim-s");

            if (typeof(dims) == "string") {
                dims = JSON.parse(dims);
            }

            // var id = self._generateChartId();
            var mSet = new epiviz.measurements.MeasurementSet();
            var tMeasurements = [];

            if(dims != null && dims.length > 0) {
                for (var idim = 0; idim < dims.length; idim++) {
                    var mtdx = measurements[dims[idim]];
                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));

                    tMeasurements.push(mtdx);
                }
            }
            else if(currentChild.measurements != null && currentChild.measurements.length > 0 ){
                for (var idim = 0; idim < currentChild.measurements.length; idim++) {
                    var mtdx = currentChild.measurements[idim];
                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));

                    tMeasurements.push(mtdx);
                }
            }

            var id = currentChild.plotId;
            if(tMeasurements.length != 0) {
                currentChild.range = currentChild.range || self.range || pDom.range;
                currentChild.measurements = tMeasurements;
                var chartMeasMap = {};
                chartMeasMap[id] = mSet;

                // var dataManagerElem = document.querySelector('epiviz-data-source[provider-id$="' + tMeasurements[0].dataprovider + '"]');
                //     var dataManager = dataManagerElem.dataManager;

                    self.dataManager.getData(currentChild.range, chartMeasMap, function(id, data) {
                        //currentChild.data = data;
                        var dataChartElem = pDom.querySelector('[plot-id$="' + id + '"]') || Polymer.dom(pDom).querySelector('[plot-id$="' + id + '"]');
                        if(dataChartElem) {
                            dataChartElem.data = pDom.transformFunc(data);
                        }
                    });
                }
            }
        },

        /**
         * Handles data requests when dimensions are changed/updated 
         * 
         * @param {string} cId Id of the chart
         */
        _updateChart: function(cId) {

            if(cId == undefined) {return;}
            var self = this;
            var currentChild = Polymer.dom(self).querySelector('[plot-id$="' + cId + '"]');
            var dims = currentChild.dimS || currentChild.getAttribute("dim-s");
            $('#' + cId).empty();

            if (typeof(dims) == "string") {
                dims = JSON.parse(dims);
            }

            var mSet = new epiviz.measurements.MeasurementSet();
            var tMeasurements = [];

            if(dims != null && dims.length > 0) {
                for (var idim = 0; idim < dims.length; idim++) {
                    var mtdx = self.measurements[dims[idim]];
                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));
                    tMeasurements.push(mtdx);
                }
            }
            else if(currentChild.measurements != null && currentChild.measurements.length > 0 ){
                for (var idim = 0; idim < currentChild.measurements.length; idim++) {
                    var mtdx = currentChild.measurements[idim];
                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));

                    tMeasurements.push(mtdx);
                }
            }

            if(tMeasurements.length != 0) {
                currentChild.range = currentChild.range || self.range;
                currentChild.measurements = tMeasurements;
                var chartMeasMap = {};
                chartMeasMap[cId] = mSet;

                // var dataManagerElem = document.querySelector('epiviz-data-source[provider-id$="' + tMeasurements[0].dataprovider + '"]');
                if(self.dataManager) {
                //     var dataManager = dataManagerElem.dataManager;

                    self.dataManager.getData(currentChild.range, chartMeasMap, function(id, data) {
                        //currentChild.data = data;
                        var dataChartElem = Polymer.dom(self).querySelector('[plot-id$="' + id + '"]');

                        dataChartElem.data = self.transformFunc(data);
                    });
                }
            }
        }
    }
</script><link rel="import" href="../iron-icons/image-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dropdown-input/paper-dropdown-input.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-label/iron-label.html">

<dom-module id="epiviz-chart-colors">

    <template>
        <style>
            .flex {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
                padding: 20px;
                flex: 1 1 auto;
            }

            .flex-end-justified {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
            }

            #formSettings {
                min-width: 500px;
            }

            #scrollContent {
                margin-bottom: 10px;
            }

            .color-item {
                display: block;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="settings">
            <!--no-overlap horizontal-align="left" vertical-align="top"-->
            <paper-dialog id="modal" modal="">
                <h2>Chart Color Settings</h2>
                <form is="iron-form" id="formSettings">
                    <paper-dialog-scrollable id="scrollContent">

                        <div class="container flex">
                            <div class="flexchild">
                                <template is="dom-repeat" items="{{labels}}">
                                    <template restamp="true" is="dom-if" if="[[_isIndexGroup(index, 0)]]">
                                        <div class="color-item">
                                            <paper-swatch-picker id="[[_getId(item)]]" name="{{item}}" color="[[_getColor(item)]]"></paper-swatch-picker>
                                            <iron-label for="{{_getId(item)}}">{{item}}</iron-label>
                                        </div>
                                    </template>
                                </template>
                            </div>
                            <div class="flexchild">
                                <template is="dom-repeat" items="{{labels}}">
                                    <template restamp="true" is="dom-if" if="[[_isIndexGroup(index, 1)]]">
                                        <div class="color-item">                                        
                                            <paper-swatch-picker id="[[_getId(item)]]" name="{{item}}" color="[[_getColor(item)]]"></paper-swatch-picker>
                                            <iron-label for="{{_getId(item)}}">{{item}}</iron-label>
                                        </div>
                                    </template>
                                </template>
                            </div>
                            <div class="flexchild">
                                <template is="dom-repeat" items="{{labels}}">
                                    <template restamp="true" is="dom-if" if="[[_isIndexGroup(index, 2)]]">
                                        <div class="color-item">
                                            <paper-swatch-picker id="[[_getId(item)]]" name="{{item}}" color="[[_getColor(item)]]"></paper-swatch-picker>
                                            <iron-label for="{{_getId(item)}}">{{item}}</iron-label>
                                        </div>
                                    </template>
                                </template>
                            </div>
                        </div>

                    </paper-dialog-scrollable>
                    <div class="container flex-end-justified">
                        <paper-button id="submit" raised="">Apply</paper-button>
                        <paper-button id="cancel" raised="">Cancel</paper-button>
                    </div>
                </form>
            </paper-dialog>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-chart-colors',

            /* Properties that can be defined on the element */
            properties: {

                /**
                * Default chart color labels.
                *
                * @type {Object<string, string>}
                */
                labels: {
                    type: Object,
                    notify: true
                },

                /**
                * Default chart color palettes.
                *
                * @type {Array<epiviz.ui.charts.ColorPalette>}
                */
                palettes: {
                    type: Array,
                    notify: true
                },

                /**
                * currently selected chart colors.
                *
                * @type {Object<string, string>}
                */
                selected: {
                    type: Object,
                    notify: true
                }
            },

            listeners: {
                'submit.click': '_submit',
                'cancel.click': '_cancel'
            },

            /**
             * Get Color for a given label/Key.
             *
             * @param {string} label label/key to search for.
             *
             * @return {Object} color set for the given label
             */
            _getColor: function(label) {
                return this.selected.getByKey(label);
            },

            /**
             * UI Helper function to find group
             *
             * @param {string} value index number
             * @param {number} expeced expected group
             * @return {boolean} returns True if value in expected
             */
            _isIndexGroup(value, expected) {
                if( value % 3 == expected ) {
                    return true;
                }

                return false;
            },

            /**
             * UI Helper function to create Id for a given label (ignore spaces)
             *
             * @param {string} label string
             * 
             * @return {string} return label ignoring white spaces
             */
            _getId: function(label) {
                return label.split(' ').join('');
            },

            /**
             * handles form submit action
             */
            _submit: function(event) {
                this.$.formSettings.submit();
            },

            /**
             * handles form submit action
             */
            _form_submit: function(event) {
                var self = this;

                //collect all colors set
                colors = [];
                for (var i=0; i < this.labels.length; i++) {
                    var swatch = self.$$('#' + this._getId(this.labels[i]));
                    colors.push(swatch.color);
                }

                self.selected = new epiviz.ui.charts.ColorPalette(colors, undefined, undefined, self.selected.keyIndices());

                // this.vals = event.detail;
                this.callback(colors);
                this.closeColors();
            },

            /**
             * handles form cancel action
             */
            _cancel: function(event) {
                this.closeColors();
            },

            /**
             * handles element modal show action
             */
            showColors: function(target, callback) {
                this.callback = callback;
                this.$.modal.positionTarget = target;
                this.$.modal.open();
            },

            /**
             * handles element modal close action
             */
            closeColors: function() {
                this.$.modal.close();
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                self.$.scrollContent.dialogElement = self.$.modal;
                self.$.formSettings.addEventListener('iron-form-submit', this._form_submit.bind(self));
            }
        });
    </script>
</dom-module><script>
    /**
     * `ChartColorsBehavior` object manages the `<epiviz-chart-colors>` element for each chart. 
     * All charts automatically inherit this behavior to update chart colors.
     *
     * @polymerBehavior
    **/
    epiviz.ChartColorsBehavior = {
        /**
         * Shows the `<epiviz-chart-colors>` element
         */
        _showColorsDialog: function() {
            var self = this;
            var chartContainer = this.$$('#' + this.plotId);
            var currColors = this.$$('epiviz-chart-colors');

            if(currColors == null) {
                var currColors = document.createElement('epiviz-chart-colors');
                currColors.setAttribute('labels', JSON.stringify(self.chart.colorLabels()));
                currColors.palettes = self.config.colorPalettes;
                currColors.selected = self.chart.colors();
                // chartSettingsElem.setAttribute('palettes', JSON.stringify(palettes));
                // chartSettingsElem.setAttribute('selected', JSON.stringify(selected));
                Polymer.dom(chartContainer).appendChild(currColors);
            }
            else {
                currColors.setAttribute('labels', JSON.stringify(self.chart.colorLabels()));
                currColors.selected = self.chart.colors();
            }

            currColors.showColors(self, function(newColors) {
                self.chartColors = newColors;
            });
        },

        /**
         * Initializes the `<epiviz-chart-colors>` element
         */
        _initializeColorsDialog: function() {
            var chartSettingsContainer = this.$$('#chartSettingsContainer');
            var chartContainer = this.$$('#' + this.plotId);
            var currColorIcon = this.$$('#chartColorsIcon');

            if(currColorIcon == null) {
                var iconElem = document.createElement('paper-icon-button');
                // iconElem.hidden = true;
                iconElem.id = "chartColorsIcon";
                iconElem.icon = "image:color-lens";

                iconElem.addEventListener("click", this._showColorsDialog.bind(this));
                Polymer.dom(chartSettingsContainer).appendChild(iconElem);
            }
        }        
    }
</script><link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<dom-module id="epiviz-chart-settings">

    <template>
        <style>
            .flex {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
                padding: 20px;
            }

            .flex-end-justified {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
            }

            .collapse-content {
                padding: 15px;
                border: 1px solid #dedede;
                border-top: none;
                display: block;
                margin:3px;
            }

            .collapse-header {
                padding: 10px 15px;
                background-color: #f3f3f3;
                border: 1px solid #dedede;
                border-radius: 5px;
                cursor: pointer;
                width: 100%;
                text-align: left;
                margin-top: 10px;
            }

            #formSettings {
                min-width: 400px;
            }

            #scrollContent {
                margin-bottom: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="settings">
            <!--no-overlap horizontal-align="left" vertical-align="top"-->
            <paper-dialog id="modal" modal="">
                <h2>Title and Margins</h2>
                <form is="iron-form" id="formSettings">
                    <paper-dialog-scrollable id="scrollContent">
                        <button class="collapse-header" on-click="toggleCommon">Chart Title and Margins</button>
                        <iron-collapse id="commonSettings">
                            <div class="collapse-content">
                                <div class="container flex">
                                    <div class="flexchild">
                                        <template is="dom-repeat" items="{{defs}}" filter="_isCommonSetting">
                                            <template restamp="true" is="dom-if" if="[[_isIndex(index, 'even')]]">
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'boolean')]]">
                                                    <paper-toggle-button name="{{item.id}}" label="{{item.label}}" checked="[[_getValue(item.id)]]"></paper-toggle-button>
                                                    <iron-label for="{{item.id}}">{{input.label}}</iron-label>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'string')]]">
                                                    <paper-input name="{{item.id}}" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'number')]]">
                                                    <paper-input name="{{item.id}}" type="number" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'array')]]">
                                                    <paper-dropdown-input name="{{item.id}}" value="[[_getValue(item.id)]]" label="{{item.label}}" items="{{item.possibleValues}}"></paper-dropdown-input>
                                                </template>
                                            </template>
                                        </template>
                                    </div>
                                    <div class="flexchild">
                                        <template is="dom-repeat" items="{{defs}}" filter="_isCommonSetting">
                                            <template restamp="true" is="dom-if" if="[[_isIndex(index, 'odd')]]">
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'boolean')]]">
                                                    <paper-toggle-button name="{{item.id}}" label="{{item.label}}" checked="[[_getValue(item.id)]]"></paper-toggle-button>
                                                    <iron-label for="{{item.id}}">{{input.label}}</iron-label>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'string')]]">
                                                    <paper-input name="{{item.id}}" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'number')]]">
                                                    <paper-input name="{{item.id}}" type="number" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'array')]]">
                                                    <paper-dropdown-input name="{{item.id}}" value="[[_getValue(item.id)]]" label="{{item.label}}" items="{{item.possibleValues}}"></paper-dropdown-input>
                                                </template>
                                            </template>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </iron-collapse>
                        <!--<template is="dom-repeat" items="{{defs}}", filter="isCommonSettings">
                        </template>-->

                        <button class="collapse-header" on-click="toggleStats">Chart Settings</button>
                        <iron-collapse id="statsSettings">
                            <div class="collapse-content">
                                <div class="container flex">
                                    <div class="flexchild">
                                        <template is="dom-repeat" items="{{defs}}" filter="_isStatSetting">
                                            <template restamp="true" is="dom-if" if="[[_isIndex(index, 'even')]]">
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'boolean')]]">
                                                    <paper-toggle-button name="{{item.id}}" label="{{item.label}}" checked="[[_getValue(item.id)]]"></paper-toggle-button>
                                                    <iron-label for="{{item.id}}">{{input.label}}</iron-label>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'string')]]">
                                                    <paper-input name="{{item.id}}" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'number')]]">
                                                    <paper-input name="{{item.id}}" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'array')]]">
                                                    <paper-dropdown-input name="{{item.id}}" value="[[_getValue(item.id)]]" label="{{item.label}}" items="{{item.possibleValues}}"></paper-dropdown-input>
                                                </template>
                                            </template>
                                        </template>
                                    </div>
                                    <div class="flexchild">
                                        <template is="dom-repeat" items="{{defs}}" filter="_isStatSetting">
                                            <template restamp="true" is="dom-if" if="[[_isIndex(index, 'odd')]]">
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'boolean')]]">
                                                    <paper-toggle-button name="{{item.id}}" label="{{item.label}}" checked="[[_getValue(item.id)]]"></paper-toggle-button>
                                                    <iron-label for="{{item.id}}">{{input.label}}</iron-label>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'string')]]">
                                                    <paper-input name="{{item.id}}" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'number')]]">
                                                    <paper-input name="{{item.id}}" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                                                </template>
                                                <template restamp="true" is="dom-if" if="[[_settingType(item.type, 'array')]]">
                                                    <paper-dropdown-input name="{{item.id}}" value="[[_getValue(item.id)]]" label="{{item.label}}" items="{{item.possibleValues}}"></paper-dropdown-input>
                                                </template>
                                            </template>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </iron-collapse>
                        
                    </paper-dialog-scrollable>
                    <div class="container flex-end-justified">
                        <paper-button id="submit" raised="">Apply</paper-button>
                        <paper-button id="cancel" raised="">Cancel</paper-button>
                    </div>
                </form>
            </paper-dialog>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-chart-settings',

            /* Properties that can be defined on the element */
            properties: {

                /**
                * Default chart setting definitions.
                *
                * @type {Array.<epiviz.ui.charts.CustomSetting>}
                */
                defs: {
                    type: Array,
                    notify: true
                },

                /**
                * Currently set chart setting values.
                *
                * @type {Object.<string, *>}
                */
                vals: {
                    type: Object,
                    notify: true
                }
            },

            listeners: {
                'submit.click': '_submit',
                'cancel.click': '_cancel'
            },

            /**
             * Toggle handler for showing chart settings
             */
            toggleCommon: function(event) {
                this.$.commonSettings.toggle();
                event.preventDefault();
                event.stopPropagation();

            },

            /**
             * Toggle handler for showing chart stat settings
             */
            toggleStats: function(event) {
                this.$.statsSettings.toggle();
                event.preventDefault();
                event.stopPropagation();
            },

            /**
             * whether a setting is a common setting.
             *
             * @param {string} item setting name/label.
             *
             * @return {boolean} if item is common setting
             */
            _isCommonSetting: function(item) {
                var commonSettings = ['title', 'marginTop', 'marginBottom', 'marginRight', 'marginLeft'];
                if(commonSettings.indexOf(item.id) != -1 ) {
                    return true;
                }

                return false;
            },

            /**
             * whether a setting is a stat setting.
             *
             * @param {string} item setting name/label.
             *
             * @return {boolean} if item is stat setting
             */
            _isStatSetting: function(item) {
                return !this._isCommonSetting(item);
            },

            /**
             * UI helper function for finding a setting type
             *
             * @param {string} type input setting type.
             * @param {string} expected expected setting type.
             * @return {boolean} return true if type and expected match
             */
            _settingType: function(type, expected) {
                if(expected == 'array') {
                    expected = ['categorical', 'measurementsMetadata', 'measurementsAnnotation'];
                    return expected.indexOf(type) === -1 ? false : true;

                    // if(expected.indexOf(type) != -1) {
                    //     var def = null;
                    //     for(var i=0; i< this.defs.length; i++){
                    //         if(this.defs[i].id == id) {
                    //             def = this.defs[i];
                    //         }
                    //     }

                    //     if(def.possibleValues === null) {return false;}
                    //     else {return true;}
                    // }
                }
                return type == expected;
            },

            /**
             * UI helper function for grouping settings by type
             *
             * @param {string} value input setting index.
             * @param {string} type expected setting group.
             * @return {boolean} return true if value and type match
             */
            _isIndex(value, type) {
                if( (value % 2 == 0 && type == "even") || (value%2 == 1 && type == "odd")) {
                    return true;
                }

                return false;
            },

            /**
             * UI helper function get value for a given setting id
             *
             * @param {string} id setting id.
             * @return {number|string} return setting value
             */
            _getValue: function(id) {
                // var def = null;
                return this.vals[id];
            },
            
            /**
             * handles form submit action
             */
            _submit: function(event) {
                this.$.formSettings.submit();
            },

            /**
             * handles form submit action
             */
            _form_submit: function(event) {
                var self = this;
                this.vals = event.detail;
                //  format vals types
                this.defs.forEach(function(def) {
                    if(def.type == "number" && self.vals[def.id] != "default") {
                        self.vals[def.id] = parseFloat(self.vals[def.id]);
                    }

                    if(def.type == "boolean") {
                        if(self.vals[def.id] == "on") {
                            self.vals[def.id] = true;
                        }
                        else {
                            self.vals[def.id] = false;
                        }
                    }
                });
                this.callback(this.vals);
                this.closeSettings();
            },

            /**
             * handles form cancel action
             */
            _cancel: function(event) {
                this.closeSettings();
            },

            /**
             * handles form show modal action
             */
            showSettings: function(target, callback) {
                this.callback = callback;
                this.$.modal.positionTarget = target;
                this.$.modal.open();
            },

            /**
             * handles form close modal action
             */
            closeSettings: function() {
                this.$.modal.close();
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;

                self.$.scrollContent.dialogElement = self.$.modal;
                self.$.formSettings.addEventListener('iron-form-submit', this._form_submit.bind(self));
            },

            /* callback function after the element is attached to the DOM (ready and created) */
            attached: function() {
                for(var i=0; i< this.defs.length; i++){
                        // def = this.defs[i];
                    var id = this.defs[i].id;
                    expected = ['categorical', 'measurementsMetadata', 'measurementsAnnotation']
                    if(expected.indexOf(this.defs[i].type) != -1) {
                        if(this.defs[i].possibleValues == null) {
                            this.defs[i].possibleValues = [this.vals[id]];
                        }
                        else if(this.defs[i].possibleValues.indexOf(this.vals[id]) === -1) {
                            this.defs[i].possibleValues.push(this.vals[id]);
                        }
                    }
                }
            }
        });
    </script>
</dom-module><script>
    /**
     * `ChartSettingsBehavior` object manages the `<epiviz-chart-settings>` element for each chart. 
     * All charts automatically inherit this behavior to update chart settings.
     *
     * @polymerBehavior
    **/
    epiviz.ChartSettingsBehavior = {

        /**
         * Shows the `<epiviz-chart-settings>` element
         */
        _showSettingsDialog: function() {
            var self = this;
            var chartContainer = this.$$('#' + this.plotId);
            var currSetting = this.$$('epiviz-chart-settings');

            if(currSetting == null) {
                var currSetting = document.createElement('epiviz-chart-settings');
                currSetting.setAttribute('defs', JSON.stringify(self.chartType.customSettingsDefs()));
                currSetting.setAttribute('vals', JSON.stringify(self.chartSettings));

                Polymer.dom(chartContainer).appendChild(currSetting);
            }
            else {
                currSetting.setAttribute('vals', JSON.stringify(self.chartSettings));
            }

            currSetting.showSettings(self, function(newSettings) {
                self.chartSettings = newSettings;
            });
        },

        /**
         * Initializes the `<epiviz-chart-settings>` element
         */
        _initializeSettingsDialog: function() {
            var chartSettingsContainer = this.$$('#chartSettingsContainer');
            var chartContainer = this.$$('#' + this.plotId);
            var currSettingIcon = this.$$('#chartSettingsIcon');

            if(currSettingIcon == null) {
                var iconElem = document.createElement('paper-icon-button');
                // iconElem.hidden = true;
                iconElem.id = "chartSettingsIcon";
                iconElem.icon = "settings";

                iconElem.addEventListener("click", this._showSettingsDialog.bind(this));
                Polymer.dom(chartSettingsContainer).appendChild(iconElem);
            }
        }        
    }
</script><dom-module id="epiviz-blocks-track">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                width: 900px;
                min-height: 90px;
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="chart" on-mouseover="hostHovered" on-mouseout="hostUnhovered">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-blocks-track',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartSettingsBehavior, epiviz.ChartColorsBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                * Default chart properties for blocks track.
                *
                * @type {Object}
                */
                configSrc: {
                    type: Object,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: 900,
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                }
                            },

                            chartCustomSettings: {
                                'epiviz.plugins.charts.BlocksTrack': {
                                    minBlockDistance: 3,
                                    useColorBy: false,
                                    blockColorBy: 'label'
                                }
                            },

                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'cancer',
                        'name': 'Expression Colon Cancer',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }, {
                        'id': 'normal',
                        'name': 'Expression Colon Normal',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);
                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                    });
                }
            },

            /* callback function after the element is initialized & attached */
            ready: function() {
                var self = this;
                self.plotId = self.plotId || self._generatePlotId();
                self.config = new epiviz.Config(self.configSrc);
            },

            /**
             * Draws the chart.
             *
             * @param {Object<epiviz.datatypes.GenomicRange>} range genomic range.
             * @param {Object<epiviz.datatypes.MapGenomicData>} data to plot
             */
            _draw: function() {
                this.chart.draw(this.range, this.data);
            },

            /**
             * Creates an instance of the blocks track chart.
             *
             * @return {epiviz.plugins.charts.BlocksTrackType} BlocksTrack chart object
             */
            _createChart: function() {
                var self = this;
                return new epiviz.plugins.charts.BlocksTrackType(self.config);
            }
        });
    </script>
</dom-module><dom-module id="epiviz-genes-track">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 450px;
                min-height: 90px;
                width: auto;
                height: auto;
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                /*-moz-transition:width 0.01s, height 0.01s;
                -webkit-transition:width 0.01s, height 0.01s;
                -o-transition:width 0.01s, height 0.01s;*/
                transition:width 0.01s, height 0.01s;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="chart" on-mouseover="hostHovered" on-mouseout="hostUnhovered">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-genes-track',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartSettingsBehavior, epiviz.ChartColorsBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Default chart properties for genes track.
                 *
                 * @type {Object}
                 */
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: 900,
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                'epiviz.plugins.charts.GenesTrack': {
                                    height: 120,
                                    colors: 'genes-default'
                                },
                            },

                            chartCustomSettings: {
                                'epiviz.plugins.charts.GenesTrack': {

                                },
                            },

                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                // if(parent.nodeName === "EPIVIZ-NAVIGATION") {
                //     parent.addEventListener('hover', function(e) {
                //         self.hover(e.detail.data);
                //     }.bind(self));

                //     parent.addEventListener('unHover', function(e) {
                //         self.unHover();
                //     }.bind(self));
                // }

                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'genes',
                        'name': 'Genes',
                        'type': 'range',
                        'datasourceId': 'genes',
                        'datasourceGroup': 'genes',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': "Genes Track",
                        'annotation': null,
                        'minValue': null,
                        'maxValue': null,
                        'metadata': ['gene', 'entrez', 'exon_starts', 'exon_ends']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);

                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                // style observer on charts
                self.plotId = self.plotId || self._generatePlotId();
                // self.scopeSubtree(self.$.chart, true);
                self.config = new epiviz.Config(self.configSrc);

                // self.listen(self.$.chart, 'iron-resize', 'onElementResize');

                // this.addEventListener("transitionend","onElementResize");
            },

            /**
             * Draws the chart.
             *
             * @param {Object<epiviz.datatypes.GenomicRange>} range genomic range.
             * @param {Object<epiviz.datatypes.MapGenomicData>} data to plot
             */
            _draw: function() {
                this.chart.draw(this.range, this.data);
            },

            /**
             * Creates an instance of the genes track chart.
             *
             * @return {epiviz.plugins.charts.GenesTrackType} GenesTrack chart object
             */
            _createChart: function() {
                var self = this;
                return new epiviz.plugins.charts.GenesTrackType(self.config);
            }
        });
    </script>
</dom-module><dom-module id="epiviz-heatmap-plot">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="chart" on-mouseover="hostHovered" on-mouseout="hostUnhovered">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-heatmap-plot',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartSettingsBehavior, epiviz.ChartColorsBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Default chart properties for heatmap plot.
                 *
                 * @type {Object}
                 */
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: '100%',
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },
                                'epiviz.plugins.charts.HeatmapPlot': {
                                    width: 800,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(80, 120, 40, 40),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton',
                                        'epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton',
                                        'epiviz.ui.charts.decoration.ChartColorByRowCodeButton'
                                    ],
                                    colors: 'heatmap-default'
                                }
                            },

                            chartCustomSettings: {
                                'epiviz.plugins.charts.HeatmapPlot': {
                                    colLabel: 'label',
                                    maxColumns: 120,
                                    clusteringAlg: 'agglomerative'
                                }
                            },

                            clustering: {
                                algorithms: [
                                    'epiviz.ui.charts.transform.clustering.NoneClustering',
                                    'epiviz.ui.charts.transform.clustering.AgglomerativeClustering'
                                ],
                                metrics: ['epiviz.ui.charts.transform.clustering.EuclideanMetric'],
                                linkages: ['epiviz.ui.charts.transform.clustering.CompleteLinkage']
                            },
                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'cancer',
                        'name': 'Expression Colon Cancer',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }, {
                        'id': 'normal',
                        'name': 'Expression Colon Normal',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);
                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;
                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                self.plotId = self.plotId || self._generatePlotId();
                // style observer on charts
                // self.scopeSubtree(self.$.chart, true);
                self.config = new epiviz.Config(self.configSrc);
                epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.initialize(self.config);
            },

            /**
             * Draws the chart.
             *
             * @param {Object<epiviz.datatypes.GenomicRange>} range genomic range.
             * @param {Object<epiviz.datatypes.MapGenomicData>} data to plot
             */
            _draw: function() {
                this.chart.draw(this.range, this.data);
            },

            /**
             * Creates an instance of the Heatmap plot chart.
             *
             * @return {epiviz.plugins.charts.HeatmapPlotType} HeatmapPlot chart object
             */
             _createChart: function() {
                var self = this;
                return new epiviz.plugins.charts.HeatmapPlotType(self.config);
            }
        });
    </script>
</dom-module><dom-module id="epiviz-line-plot">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="chart" on-mouseover="hostHovered" on-mouseout="hostUnhovered">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-line-plot',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartSettingsBehavior, epiviz.ChartColorsBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Default chart properties for line plot.
                 *
                 * @type {Object}
                 */
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: '100%',
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                'epiviz.plugins.charts.LinePlot': {
                                    width: 800,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(30, 30, 50, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton',
                                        'epiviz.ui.charts.decoration.ChartColorByRowCodeButton',
                                        'epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton'
                                    ],
                                    colors: 'd3-category20b'
                                }
                            },

                            chartCustomSettings: {

                            },

                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},
            
            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'cancer',
                        'name': 'Expression Colon Cancer',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }, {
                        'id': 'normal',
                        'name': 'Expression Colon Normal',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);

                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                self.plotId = self.plotId || self._generatePlotId();
                // style observer on charts
                // self.scopeSubtree(self.$.chart, true);

                self.config = new epiviz.Config(self.configSrc);
            },

            /**
             * Draws the chart.
             *
             * @param {Object<epiviz.datatypes.GenomicRange>} range genomic range.
             * @param {Object<epiviz.datatypes.MapGenomicData>} data to plot
             */
            _draw: function() {
                this.chart.draw(this.range, this.data);
            },

            /**
             * Creates an instance of the line plot chart.
             *
             * @return {epiviz.plugins.charts.LinePlotType} LinePlot chart object
             */
            _createChart: function() {
                var self = this;
                return new epiviz.plugins.charts.LinePlotType(self.config);
            }
        });
    </script>
</dom-module><dom-module id="epiviz-line-track">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 900px;
                min-height: 90px;
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
            }

            /*::shadow .line-plot .items .bg-line { stroke: #dddddd; stroke-opacity: 0.1; }
            ::shadow .line-plot .hovered .bg-line { stroke-opacity: 1!important; opacity: 1!important; }

            ::shadow .line-track {}*/
        </style>

        <!-- local DOM goes here -->
        <div id="chart" on-mouseover="hostHovered" on-mouseout="hostUnhovered">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-line-track',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartSettingsBehavior, epiviz.ChartColorsBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Default chart properties for line track.
                 *
                 * @type {Object}
                 */
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: 900,
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                'epiviz.plugins.charts.LineTrack': {
                                    colors: 'epiviz-v2-bright',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton',
                                        'epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton'
                                    ]
                                },
                            },

                            chartCustomSettings: {
                                'epiviz.plugins.charts.LineTrack': {
                                    step: 1,
                                    showPoints: false,
                                    showLines: true,
                                    pointRadius: 1,
                                    lineThickness: 2
                                },
                            },

                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'cancer',
                        'name': 'Expression Colon Cancer',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }, {
                        'id': 'normal',
                        'name': 'Expression Colon Normal',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);

                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                        //self._draw();
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                self.plotId = self.plotId || self._generatePlotId();
                // style observer on charts
                // self.scopeSubtree(self.$.chart, true);
                self.config = new epiviz.Config(self.configSrc);
            },

            /**
             * Draws the chart.
             *
             * @param {Object<epiviz.datatypes.GenomicRange>} range genomic range.
             * @param {Object<epiviz.datatypes.MapGenomicData>} data to plot
             */
            _draw: function() {
                this.chart.draw(this.range, this.data);
            },

            /**
             * Creates an instance of the line track chart.
             *
             * @return {epiviz.plugins.charts.LineTrackType} LineTrack chart object
             */
            _createChart: function() {
                var self = this;
                return new epiviz.plugins.charts.LineTrackType(self.config);
            }
        });
    </script>
</dom-module><dom-module id="epiviz-scatter-plot">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="chart" on-mouseover="hostHovered" on-mouseout="hostUnhovered">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>

        Polymer({
            /* Custom element html tag */
            is: 'epiviz-scatter-plot',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartSettingsBehavior, epiviz.ChartColorsBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Default chart properties for scatter plot.
                 *
                 * @type {Object}
                 */
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: '100%',
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                'epiviz.plugins.charts.ScatterPlot': {
                                    margins: new epiviz.ui.charts.Margins(15, 50, 50, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ChartColorByRowCodeButton'
                                    ]
                                }
                            },

                            chartCustomSettings: {
                                'epiviz.plugins.charts.ScatterPlot': {
                                    circleRadiusRatio: 0.01
                                }
                            },

                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;
                
                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                // if(parent.nodeName === "EPIVIZ-NAVIGATION") {
                //     parent.addEventListener('hover', function(e) {
                //         self.hover(e.detail.data);
                //     }.bind(self));

                //     parent.addEventListener('unHover', function(e) {
                //         self.unHover();
                //     }.bind(self));
                // }

                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'cancer',
                        'name': 'Expression Colon Cancer',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }, {
                        'id': 'normal',
                        'name': 'Expression Colon Normal',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);

                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                        //self._draw();
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                self.plotId = self.plotId || self._generatePlotId();
                // style observer on charts
                // self.scopeSubtree(self.$.chart, true);
                self.config = new epiviz.Config(self.configSrc);
            },
            
            /**
             * Draws the chart.
             *
             * @param {Object<epiviz.datatypes.GenomicRange>} range genomic range.
             * @param {Object<epiviz.datatypes.MapGenomicData>} data to plot
             */
            _draw: function() {
                this.chart.draw(this.range, this.data);
            },

            /**
             * Creates an instance of the scatter plot chart.
             *
             * @return {epiviz.plugins.charts.ScatterPlotType} ScatterPlot chart object
             */
            _createChart: function() {
                var self = this;
                return new epiviz.plugins.charts.ScatterPlotType(self.config);
            }
        });
    </script>
</dom-module><dom-module id="epiviz-stacked-line-track">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 900px;
                min-height: 90px;
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="chart" on-mouseover="hostHovered" on-mouseout="hostUnhovered">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-stacked-line-track',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartSettingsBehavior, epiviz.ChartColorsBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Default chart properties for stacked-line track.
                 *
                 * @type {Object}
                 */
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: 900,
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                'epiviz.plugins.charts.StackedLineTrack': {
                                    height: 300
                                },
                            },

                            chartCustomSettings: {

                            },

                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'cancer',
                        'name': 'Expression Colon Cancer',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }, {
                        'id': 'normal',
                        'name': 'Expression Colon Normal',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);

                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                self.plotId = self.plotId || self._generatePlotId();
                // style observer on charts
                // self.scopeSubtree(self.$.chart, true);
                self.config = new epiviz.Config(self.configSrc);
            },

            /**
             * Draws the chart.
             *
             * @param {Object<epiviz.datatypes.GenomicRange>} range genomic range.
             * @param {Object<epiviz.datatypes.MapGenomicData>} data to plot
             */
            _draw: function() {
                this.chart.draw(this.range, this.data);
            },

            /**
             * Creates an instance of the stacked-line track chart.
             *
             * @return {epiviz.plugins.charts.StackedLineTrackType} StackedLineTrack chart object
             */
            _createChart: function() {
                var self = this;
                return new epiviz.plugins.charts.StackedLineTrackType(self.config);
            }
        });
    </script>
</dom-module><dom-module id="epiviz-stacked-line-plot">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <div id="chart" on-mouseover="hostHovered" on-mouseout="hostUnhovered">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-stacked-line-plot',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartSettingsBehavior, epiviz.ChartColorsBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Default chart properties for stacked-line plot.
                 *
                 * @type {Object}
                 */
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: '100%',
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                'epiviz.plugins.charts.StackedLinePlot': {
                                    width: 800,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(30, 30, 50, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton',
                                        'epiviz.ui.charts.decoration.ChartColorByRowCodeButton',
                                        'epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton'
                                    ],
                                    colors: 'd3-category20b'
                                }
                            },

                            chartCustomSettings: {
                                'epiviz.plugins.charts.StackedLinePlot': {
                                    colLabel: 'label'
                                }
                            },

                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'cancer',
                        'name': 'Expression Colon Cancer',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }, {
                        'id': 'normal',
                        'name': 'Expression Colon Normal',
                        'type': 'feature',
                        'datasourceId': 'gene_expression',
                        'datasourceGroup': 'affymetrix_probeset',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': null,
                        'annotation': null,
                        'minValue': -3,
                        'maxValue': 20,
                        'metadata': ['probe']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);

                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                self.plotId = self.plotId || self._generatePlotId();
                // style observer on charts
                // self.scopeSubtree(self.$.chart, true);
                self.config = new epiviz.Config(self.configSrc);
            },

            /**
             * Draws the chart.
             *
             * @param {Object<epiviz.datatypes.GenomicRange>} range genomic range.
             * @param {Object<epiviz.datatypes.MapGenomicData>} data to plot
             */
            _draw: function() {
                this.chart.draw(this.range, this.data);
            },

            /**
             * Creates an instance of the stacked-line plot chart.
             *
             * @return {epiviz.plugins.charts.StackedLinePlotType} StackedLinePlot chart object
             */
            _createChart: function() {
                var self = this;
                return new epiviz.plugins.charts.StackedLinePlotType(self.config);
            }
        });
    </script>
</dom-module><script>(function() {
  var cyto_chr = {}, d3 = window.d3;

  if (typeof module !== 'undefined' && module.exports) {
    module.exports = cyto_chr;
    d3 = require('d3');
  } else if(typeof angular !== 'undefined') {} else {
    window.cyto_chr = cyto_chr;
  }
  
(function(cyto_chr, d3) {
  'use strict'
  cyto_chr.margin = {
    top: 38,
    left: 14,
    right: 5
  };

  var CHR1_BP_END = 248956422;
  var CHR1_BP_MID = 121700000;

  var Chromosome = function() {
    this._segment = '1';
    this._selectionMode = 'single';
    this._domTarget = d3.select(document.documentElement);
    this._resolution = "550";
    this._width = null;
    this._height = 17;
    this._useRelative = true;
    this._showAxis = false;
    this.dispatch = d3.dispatch('bandclick', 'selectorchange', 'selectorend', 'selectordelete', "selectorhover", "selectorunhover");
    this.rendered = false;
    this.selectors = [];
    this.model = [];
    this.maxBasePair = 0;
    this.xscale = d3.scale.linear();
  };

  Chromosome.prototype.getMaxBasepair = function() {
    return this.maxBasePair;
  };

  Chromosome.prototype.segment = function (a) {
    if (typeof a === 'number') a = a.toString();
    return cyto_chr.InitGetterSetter.call(this, '_segment', a);
  };

  Chromosome.prototype.selectionMode = function (a) {
    return cyto_chr.InitGetterSetter.call(this, '_selectionMode', a);
  };

  Chromosome.prototype.target = function (a) {
    // if(typeof a === 'string') 
    a = d3.select(a);
    // if(a.empty()) {
    //   throw "Error: Invalid dom target";
    // }
    return cyto_chr.InitGetterSetter.call(this, '_domTarget', a);
  };

  Chromosome.prototype.resolution = function (a) {
    if (typeof a === 'number') a = a.toString();
    if (a === "400" || a === "550" || a ==="850" || a === "1200" || a === undefined) {
      return cyto_chr.InitGetterSetter.call(this, '_resolution', a);
    } else {
      throw "Error: Invalid resolution. Please enter 400, 550, 850, or 1200 only.";
    }
  };

  Chromosome.prototype.width = function (a) {
    return cyto_chr.InitGetterSetter.call(this, '_width', a);
  };

  Chromosome.prototype.height = function (a) {
    return cyto_chr.InitGetterSetter.call(this, '_height', a);
  };

  Chromosome.prototype.useRelative = function (a) {
    return cyto_chr.InitGetterSetter.call(this, '_useRelative', a);
  };

  Chromosome.prototype.showAxis = function (a) {
    return cyto_chr.InitGetterSetter.call(this, '_showAxis', a);
  };

  Chromosome.prototype.doHover = function() {
    // console.log(this.selectors[0]);
    this.svgTarget.selectAll(".extRect rect").style("stroke", "#ffc600").style("stroke-width", "5").style("stroke-opacity", "1.0");
  };

  Chromosome.prototype.doUnhover = function() {
    this.svgTarget.selectAll(".extRect rect").style("stroke-opacity", "0");
  };

  Chromosome.prototype.on = function(e, listener) {
    if (!this.dispatch.hasOwnProperty(e)) throw "Error: No event for " + e;
    this.dispatch.on(e, listener);
  };

  Chromosome.prototype.config = function(type, arg) {
    return this[type](arg);
  };

  Chromosome.prototype.renderAxis = function () {
    var bpAxis = d3.svg.axis()
      .scale(this.xscale)
      .tickFormat(d3.format('s'))
      .orient("bottom");

    if (this._useRelative && (this._segment === "Y" || this._segment === "22" || this._segment === "21" || this._segment === "20" || this._segment === "19")) {
      bpAxis.ticks(6);
    }

    var axisg = this.svgTarget.append('g')
      .classed('bp-axis', true)
      .attr('transform', 'translate('+ cyto_chr.margin.left + ',' + (this._height + cyto_chr.margin.top + 6) + ")");

      axisg.call(bpAxis);

    axisg.selectAll('text')
      // .attr('transform', 'rotate(-50)')
      .style('font', '8px sans-serif');

    axisg.selectAll('path, line')
      .style({
        "fill": "none",
        "stroke": "#666666",
        "shape-rendering": "crispEdges"
      });
  };

  Chromosome.prototype.remove = function() {
    this.svgTarget.remove();
  };

  // Chromosome.prototype.moveSelectorTo = function(start, stop) {
  //   if(arguments.length !== 2) {
  //     throw "Error moveSelectorTo: Invalid number of arguments. Both start and stop coordinates are required";
  //   }

  //   if (this.selectors.length === 0) {
  //     this.newSelector(0, "10000000");
  //   } else {
  //     this.selectors[0].move(start, stop);
  //   }

  // };

  Chromosome.prototype.newSelector = function(bp_start, bp_stop) {

    var self = this;

    function selectorRemoveCB(sel) {
      self.dispatch.selectordelete(sel);
      var index = self.selectors.indexOf(sel);
      self.selectors.splice(index, 1);
    }

    var ve = cyto_chr.selector(selectorRemoveCB)
      .x(cyto_chr.margin.left)
      .y(cyto_chr.margin.top - (this._height / 4))
      .height(this._height + (this._height / 2))
      .xscale(this.xscale)
      .extent([bp_start, bp_stop])
      .target(this.svgTarget)
      .render();

    // ve.dispatch.on('change', function(d) {
    //   self.dispatch.selectorchange(d);
    // });

    // ve.dispatch.on('changeend', function(d) {
    //   self.dispatch.selectorend(d);
    // });

    ve.dispatch.on('selectorhover', function(d) {
      self.dispatch.selectorhover(d);
    });

    ve.dispatch.on('selectorunhover', function(d) {
      self.dispatch.selectorunhover(d);
    });

    this.selectors.push(ve);
  };

  Chromosome.prototype.getSelections = function() {

    var ret = [];
    for(var i = 0; i < this.selectors.length; i++) {
      var sel = this.selectors[i].extent();
      ret.push({
        start: sel[0],
        stop: sel[1]
      })
    }
    return ret;
  };

  Chromosome.prototype.getSelectedBands = function(sensitivity) {

    var results = [];
    if (this.selectors.length > 0) {

      var se = this.selectors[0].extent();
      var selStart = +se[0];
      var selStop = +se[1];

      if (typeof sensitivity !== 'undefined') {
        selStart -= sensitivity;
        selStop += sensitivity;
      }

      results = this.model.slice().filter(function(e) {
        var bStart = +e.bp_start;
        var bStop = +e.bp_stop;

        if ((selStart >= bStart && selStart < bStop) ||
          (selStop > bStart && selStop <= bStop) ||
          (selStart <= bStart && selStop >= bStop)) {
          return true;
        } else {
          return false;
        }
      });
    }

    return results;
  };

  Chromosome.prototype.getSVGTarget = function() {
    return this.svgTarget;
  };

  Chromosome.prototype.render = function (zoomRange) {

    var self = this;

    if(self.rendered) {
      self.selectors = [];
      self.remove();
    }

    if(self._width === null) {
      var parentWidth = d3.select(self._domTarget[0][0].parentNode).node().getBoundingClientRect().width;
      self.width(parentWidth)
    }

    cyto_chr.modelLoader.load(this._segment, this._resolution, function(data) {
      self.model = data;
      self.maxBasePair = d3.max(data, function(d) {
        return +d.bp_stop;
      });

      self.segMid = 0;
      for(var j =0; j < data.length;j++) {
        if(data[j].stain ==="acen") {
          self.segMid = data[j].bp_stop;
          break;
        }
      }

      var rangeTo = self._useRelative ? (self.maxBasePair / CHR1_BP_END) * self._width : self._width;
      rangeTo -= (cyto_chr.margin.left + cyto_chr.margin.right);

      if (zoomRange) {
        self.xscale.domain([zoomRange[0], zoomRange[1]]);
      } else {
        self.xscale.domain([1, self.maxBasePair]);
      }

      self.xscale.range([0, rangeTo]);

      var h = self._height + 62;
      // var h = self._height;
      var w = self._width;

      self.svgTarget = self._domTarget
        .style('height', h + 'px')
        .style('width', (w+5) + 'px')
        .append('svg')
        .attr('width', w)
        .attr('height', h);

      var bands = self.svgTarget.selectAll('g')
        .data(data).enter();

      // self.svgTarget.append('text')
      //   .text("chr: " + self._segment)
      //   .attr('x', w - 77)
      //   .attr('y', cyto_chr.margin.top + (self._height/ 3) + 2)
      //   .attr('text-anchor','middle')
      //   .style('font', '12px sans-serif');

      function bpCoord(bp) {
        var xshift = 0;
        if(self.alignCentromere && self._segment !== "1") {
          xshift = self.xscale(CHR1_BP_MID) - self.xscale(self.segMid);
        }

        return self.xscale(bp) + cyto_chr.margin.left + xshift;
      }

      bands.append('g')
        .each(function(d, i) {

          var elem = d3.select(this);

          function applyBorder() {
            this
              .attr('stroke', '#000000')
              .attr('stroke-width', 0.2);
          }

          function drawRoundedRect(d, r, tl, tr, bl, br) {
            return this.append('path')
              .attr("d", cyto_chr.roundedRect(bpCoord(d.bp_start), cyto_chr.margin.top, bpCoord(d.bp_stop) - bpCoord(d.bp_start), self._height, r, tl, tr, bl, br))
              .style('fill', cyto_chr.getStainColour(d.stain, d.density));
          }

          var labelSkipFactor = self._resolution === '1200' ? 8 : 2;

          if (self._useRelative && self._resolution == "1200" && self._segment == 'Y') {
            labelSkipFactor = 12;
          }

          // if(i % labelSkipFactor === 0) {
          //   var bmid = (bpCoord(d.bp_stop) + bpCoord(d.bp_start)) / 2;
          //   elem.append('line')
          //     .attr('x1', bmid)
          //     .attr('y1', cyto_chr.margin.top)
          //     .attr('x2', bmid)
          //     .attr('y2', cyto_chr.margin.top - 4)
          //     .style('stroke', 'grey')
          //     .style('stroke-width',1);

          //   elem.append('text')
          //     .attr('transform', 'translate(' + bmid + ',' + (cyto_chr.margin.top - 6) + ')rotate(-50)')
          //     .style('font', '8px sans-serif')
          //     .text(d.arm + d.band);
          // }

          var rect;
          var w = bpCoord(d.bp_stop) - bpCoord(d.bp_start);
          var acenThreshold = (self._resolution == "1200") ? 7 : 6;
          if (i === 0 && w > 10) {
            rect = drawRoundedRect.call(elem, d, 4, true, false, true, false);
            applyBorder.call(rect);
          } else if (d.stain === "acen" && (w > acenThreshold)) {

            if (d.arm === "p") {
              rect = drawRoundedRect.call(elem, d, 5, false, true, false, true);

            } else if(d.arm === "q") {
              rect = drawRoundedRect.call(elem, d, 5, true, false, true, false);
            }
          } else if (i === data.length - 1) {

            rect = drawRoundedRect.call(elem, d, 5, false, true, false, true);
            applyBorder.call(rect);

          } else {

            var ys = d.stain === "stalk" ? cyto_chr.margin.top + (self._height / 4) : cyto_chr.margin.top;
            var hs = d.stain === "stalk" ? self._height / 2 : self._height;
            rect = elem.append('rect')
              .attr('x', bpCoord(d.bp_start))
              .attr('y', ys)
              .attr('height', hs)
              .attr('width', self.xscale(d.bp_stop) - self.xscale(d.bp_start))
              .style('fill', cyto_chr.getStainColour(d.stain, d.density));
            applyBorder.call(rect);
          }

          rect.append('title')
            .text(d.arm + d.band)

          rect.on('mouseover', function(d) {
            var e = d3.select(this)
              .style('opacity', "0.5")
              .style('cursor', 'pointer');

            if (d.stain === "gneg") {
              e.style('fill', cyto_chr.getStainColour("gpos", "25"));
            }

          });

          rect.on('mouseout', function(d) {
            var e = d3.select(this)
              .style('opacity', "1")
              .style('cursor', 'default');

            if (d.stain === "gneg") {
              e.style('fill', cyto_chr.getStainColour("gneg"));
            }
          });

          // rect.on('click', function(d) {
          //   // if (self.selectors.length === 0 || (self._selectionMode === 'multi' && d3.event.altKey)) {
          //   //   self.newSelector(d.bp_start, d.bp_stop);
          //   // }

          //   // if (self._selectionMode === 'single' && self.selectors.length > 0) {
          //   //   self.moveSelectorTo(d.bp_start, d.bp_stop);
          //   // }
          //   // self.dispatch.bandclick(d);
          // });
        });

      if (self._showAxis) {
        self.renderAxis();
      }

      self.rendered = true;
    });

    return self;
  };

  cyto_chr.chromosome = function() {
    return new Chromosome();
  };

})(cyto_chr || {}, d3);

(function (cyto_chr, d3) {

  var defaultDataURLs = {
    "400" : "ideogram_9606_GCF_000001305.14_400_V1",
    "550" : "ideogram_9606_GCF_000001305.14_550_V1",
    "850" : "ideogram_9606_GCF_000001305.14_850_V1",
    "1200" : "ideogram_9606_GCF_000001305.13_1200_v1"
  };

  var baseDir = 'data/';

  function CacheInstance() {
    this.status = "notloaded";
    this.cache = [];
  }

  var dataCache = {
    "400" : new CacheInstance,
    "550" : new CacheInstance,
    "850" : new CacheInstance,
    "1200" : new CacheInstance
  };

  var callQueue = [];

  function loadData(file, res, cb) {

    var c = dataCache[res];
    if (c.cache.length === 0) {
      if (c.status === "loading") {
        callQueue.push({
          res: res,
          cb: cb
        });

        return;
      } else if (c.status === "notloaded") {
        c.status = "loading";
        d3.tsv(file, function(d) {
          c.cache = d;
          c.status = "loaded";
          cb(d);

          while(callQueue.length > 0) {
            var cbq = callQueue.shift();
            cbq.cb(d);
          }

        });
      }
    } else {
      cb(c.cache);
    }
  }

  function getChromosomeData(chr, resolution, cb) {

    chr = chr || '1';
    resolution = resolution || "550";

    var fileName = defaultDataURLs[resolution];

    loadData(baseDir + fileName, resolution, function (d) {

      if(d) {
        var filteredResults = filterByChromosome(d, chr);
        cb(filteredResults);
      }

    });
  }

  function filterByChromosome(data, chr) {
    var newAry = [];
    for(var i = 0; i < data.length; i++) {
      if (data[i]['#chromosome'] === chr) {
        newAry.push(data[i]);
      }
    }
    return newAry;
  }

  cyto_chr.modelLoader = {
    load: getChromosomeData,
    setDataDir: function(d) {baseDir = d;},
    getDataDir: function() {return baseDir;}
  };

})(cyto_chr || {}, d3);

(function(cyto_chr, d3) {

  var Selector = function(closecb) {
    this._brush = d3.svg.brush();
    this.dispatch = d3.dispatch('change', 'changeend', 'selectordelete', "selectorhover", "selectorunhover");
    this._x = 0;
    this._y = 0;
    this._extent = [0,0];
    this._height = 0;
    this._closecb = closecb;
  };

  Selector.prototype.test = function(e) {
    var self = this;
    return cyto_chr.InitGetterSetter.call(this, "_test", e, function(){
      self._another = "_that";
    });
  };

  Selector.prototype.extent = function (a) {
    var self = this;
    if(typeof a === "undefined") {
      return self._brush.extent();
    }

    return cyto_chr.InitGetterSetter.call(this, "_extent", a, function(){
      self._brush.extent(a);
    });

  };

  Selector.prototype.xscale = function(a) {
    var self = this;
    return cyto_chr.InitGetterSetter.call(this, "_xscale", a, function(){
      self._brush.x(a);
    });
  };

  Selector.prototype.target = function(a) {
    return cyto_chr.InitGetterSetter.call(this, '_target', a);
  };

  Selector.prototype.height = function(a) {
    return cyto_chr.InitGetterSetter.call(this, '_height', a);
  };

  Selector.prototype.x = function(a) {
    return cyto_chr.InitGetterSetter.call(this, '_x', a);
  };

  Selector.prototype.y = function(a) {
    return cyto_chr.InitGetterSetter.call(this, '_y', a);
  };

  Selector.prototype.render = function() {
    var self = this;

    this.selector = this._target.append('g')
      .classed("extRect", true)
      .attr('transform', 'translate(' + this._x + ',' + this._y + ')')
      .call(this._brush);
    
    this.selector.selectAll(".resize").remove();

    this.selector.selectAll('rect')
      .attr('height', this._height);

    this.selector.select('.background').remove();

    var e = this.selector.select('.extent')
      .style('fill', 'steelblue')
      .style('opacity', '0.5');

    this.selector.selectAll("rect").classed("extent", false).style("cursor", "default");

    this.selector.selectAll("rect")
      .on('mouseover', function() {
        var ext = self._brush.extent();
        self.dispatch.selectorhover(ext);
      })
      .on("mouseout", function() {
        var ext = self._brush.extent();
        self.dispatch.selectorunhover(ext);
      });

    // var cbg_xpos = this._xscale(this._extent[1]) + cyto_chr.margin.left;
    // var cbg_ypos = cyto_chr.margin.top - 3;
    // var cbg = this._target.append('g');
    // cbg.append('title').text('remove');

    // this.deleteButton = cbg.append('circle')
    //   .attr('cx', cbg_xpos)
    //   .attr('cy', cbg_ypos)
    //   .attr('r', 5)
    //   .attr('fill', 'red')
    //   .on('mouseover', function() {
    //     d3.select(this)
    //       .style('cursor', 'pointer');
    //   })
    //   .on('mouseout', function(){
    //     d3.select(this)
    //       .style('cursor', 'default');
    //   })
    //   .on('click', function() {
    //     self.remove();
    //   });

    // this._brush.on('brush', function() {
    //   self.updateXButton();
    //   var ext = self._brush.extent();
    //   // self.dispatch.change(ext);
    // });

    // this._brush.on('brushend', function(d) {
    //   var ext = self._brush.extent();
    //   self.dispatch.changeend(ext);
    // });
    return this;
  };

  Selector.prototype.remove = function() {
    this.selector.remove();
    // this.deleteButton.remove();
    this._closecb(this);
    return this;
  };

  // Selector.prototype.updateXButton = function() {
  //   var e = this._brush.extent();
  //   var new_xpos = this._xscale(e[1]) + cyto_chr.margin.left;
  //   // this.deleteButton.attr('cx', new_xpos);
  // };

  // Selector.prototype.move = function(start, stop) {
  //   this._brush.extent([start, stop]);
  //   this.selector.call(this._brush);
  //   this.updateXButton();
  // };

  cyto_chr.selector = function(cb){
    return new Selector(cb);
  };

})(cyto_chr || {}, d3);

(function(cyto_chr, d3) {

  cyto_chr.initPattern = function () {
    var pg = this.append('pattern')
      .attr('id', 'acen-fill')
      .attr('patternUnits', 'userSpaceOnUse')
      .attr('x', '0')
      .attr('y', '0')
      .attr('width', '10')
      .attr('height', '10')
      .append('g')
      .style({
        "fill": "none",
        "stroke": "#708090",
        "stroke-width": "2"
      });

    pg.append('path')
      .attr('d', "M0,0 l10,10");
    pg.append('path')
      .attr('d','M10,0 l-10,10');
  };

  cyto_chr.roundedRect = function (x, y, w, h, r, tl, tr, bl, br) {
      var retval;
      retval = "M" + (x + r) + "," + y;
      retval += "h" + (w - 2 * r);
      if (tr) {
        retval += "a" + r + "," + r + " 0 0 1 " + r + "," + r;
      } else {
        retval += "h" + r;
        retval += "v" + r;
      }
      retval += "v" + (h - 2 * r);
      if (br) {
        retval += "a" + r + "," + r + " 0 0 1 " + -r + "," + r;
      } else {
        retval += "v" + r;
        retval += "h" + -r;
      }
      retval += "h" + (2 * r - w);
      if (bl) {
        retval += "a" + r + "," + r + " 0 0 1 " + -r + "," + -r;
      } else {
        retval += "h" + -r;
        retval += "v" + -r;
      }
      retval += "v" + (2 * r - h);
      if (tl) {
        retval += "a" + r + "," + r + " 0 0 1 " + r + "," + -r;
      } else {
        retval += "v" + -r;
        retval += "h" + r;
      }
      retval += "z";
      return retval;
    };

  cyto_chr.getStainColour = function (bandtype, density) {

    if(bandtype === "gpos") {
      if(density === "" || density === null) { return "#000000"; }

      switch(density) {
        case "100":
          return "#000000";
        case "75":
          return "#666666";
        case "50":
          return "#999999";
        case "25":
          return "#d9d9d9";
      }
    }

    if (bandtype === "gneg") {
      return "#ffffff";
    }

    if (bandtype === "acen") {
      //return "url(#acen-fill)";
      return "#708090";
    }

    if (bandtype === "gvar") {
      return "#e0e0e0";
    }

    if(bandtype === "stalk") {
      return "#708090";
    }

    return "green";
  };

  cyto_chr.setOption = function (userOption, def) {
      if(typeof userOption !== "undefined") {
        return userOption;
      } else {
        return def;
      }
    };

  cyto_chr.InitGetterSetter = function(prop, arg, cb) {
    if(typeof arg !== 'undefined') {
      this[prop] =  arg;
      if(typeof cb === 'function') {
        cb();
      }
      return this;
    } else {
      return this[prop];
    }
  };

})(cyto_chr || {}, d3);
(function(cyto_chr, d3){
  if (typeof angular === 'undefined') {
    return;
  }

  cyto_chr.modelLoader.setDataDir('./node_modules/cyto-chromosome-vis/data/');

  angular.module('cyto-chromosome-vis',[])
    .directive('cytochromosome',[function() {
      function link(scope, element, attr) {

        attr.resolution = cyto_chr.setOption(attr.resolution, "550");
        attr.width = cyto_chr.setOption(attr.width, 1000);
        attr.segment = cyto_chr.setOption(attr.segment, "1");
        attr.useRelative = cyto_chr.setOption(attr.useRelative, true);
        attr.showAxis = cyto_chr.setOption(attr.showAxis, false);

        cyto_chr.chromosome()
          .target(d3.select(element[0]))
          .width(attr.width)
          .segment(attr.segment)
          .resolution(attr.resolution)
          .useRelative(attr.useRelative == "true")
          .showAxis(attr.showAxis == "true")
          .render();
      }

      return {
        link: link,
        restrict: 'E'
      };
    }])
    .provider('cytochromosome', function(){
      this.build = function() {
        return cyto_chr.chromosome();
      };

      this.setDataDir = function(d) {
        cyto_chr.modelLoader.setDataDir(d);
      };

      this.$get = function() {
        return this;
      };
    });

})(cyto_chr || {}, d3);
}());</script>

<dom-module id="epiviz-ideogram-track">
    <template>
        <style>
        :host {
            display: inline-block;
            min-width: 250px;
        }
        </style>

        <!-- local DOM goes here -->
        <div id="chart">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-ideogram-track',

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Chromosome location.
                 * Default Location Attribute to set to all the children chart elements.
                 *
                 * @example: chr1
                 *
                 * @type {string}
                 */
                chromosome: {
                    type: String,
                    notify: true
                },

                /**
                 * Chromosome start. 
                 * Default Chromosome start value to use. (defaults to 0).
                 *
                 * @type {number}
                 */
                start: {
                    type: Number,
                    notify: true
                },

                /**
                 * Chromosome end. 
                 * Default Chromosome end value to use. (defaults to the `<chr>` length).
                 *
                 * @type {number}
                 */
                end: {
                    type: Number,
                    notify: true
                },

                /**
                 * Unique plot ID for the chart
                 *
                 * @type {string}
                 */
                plotId: {
                    type: String,
                    reflectToAttribute: true,
                    notify: true
                },

                /**
                 * Computed Range from `<chr>`, `<start>` & `<end>`. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                range: {
                    type: Object,
                    notify: true
                },

                /**
                 * Current gene in range (set automatically)
                 *
                 * @type {string}
                 */   
                geneInRange: {
                    type: String,
                    notify: true
                }
            },

            observers: [
                '_rangeChanged(chromosome.*, start.*, end.*)'
            ],

            /**
             * Generates a unique chart ID
             * 
             * @return {string}
             */
            _generatePlotId: function() {
                var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var result = '';
                var size = 7;

                for (var i = 0; i < size; ++i) {
                    result += chars[Math.round(Math.random() * (chars.length - 1))];
                }

                return 'epiviz-' + result;
            },

            /**
             * ChartLocation/RangeChange event handler.
             */
            _rangeChanged: function() {

                if (this.chromosome != null && this.start != null && this.end != null) {
                    if(this.plotId) {
                        this._draw();
                    }
                }
            },

            /**
             * Hover event handler.
             *
             * @param {object} data data object currently hovered.
             */
            hover: function(data) {
                this.chart.doHover(data);
            },

            /**
             * unHover event handler.
             */
            unHover: function() {
                this.chart.doUnhover();
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;

                self.plotId = self.plotId || self._generatePlotId();
                var parent = self.parentNode;
                
                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.chart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.chart.unHover();
                }.bind(self));

                self.chromosomeFactory = cyto_chr;
                self._rangeChanged();
                self.chartObject = new epiviz.ui.charts.ChartObject(self.plotId, self.start, self.end, undefined, undefined, undefined, undefined, undefined);
            },

            /**
             * Draws the chart.
             */
            _draw: function() {

                var self = this;

                self.segment = self.chromosome.replace("chr", "");

                self.chart = self.chromosomeFactory.chromosome()
                    .segment(self.segment)
                    // .resolution("850")
                    // .useRelative(false)
                    .showAxis(true)
                    .target(self.$$("#" + self.plotId))
                    // .height(100)
                    .width(300)
                    .render();

                // TODO: use callback instead after the chart is rendered
                setTimeout(function(){ 
                    self.chart.on("selectorhover", function(e) {
                        self.fire('hover', {
                            data: self.chartObject
                        });
                    }.bind(self));
                    
                    self.chart.on("selectorunhover", function(e) {
                        self.fire('unHover', {
                            data: null
                        });
                    }.bind(self));

                    self.chart.getSVGTarget().append('text')
                        .text("chr: " + self.segment)
                        .attr('x', self.chart.getSVGTarget().attr("width") - 85)
                        .attr('y', self.chart.getSVGTarget().attr("height")*2/3 - 5)
                        .attr('text-anchor','left')
                        .style('font', '12px sans-serif');

                    self.chart.getSVGTarget().append('text')
                        .text("Gene: " + self.geneInRange)
                        .attr('x', self.chart.getSVGTarget().attr("width") - 85)
                        .attr('y', self.chart.getSVGTarget().attr("height")*2/3 + 5)
                        .attr('text-anchor','left')
                        .style('font', '12px sans-serif');

                    self.chart.newSelector(self.start, self.end);
                    self.chartObject = new epiviz.ui.charts.ChartObject(self.plotId, self.start, self.end, undefined, undefined, undefined, undefined, undefined);
                }, 1000);
            }
        });
    </script>
</dom-module><script>
    /**
     * `ChartBehavior` is an interface to all epiviz-charts. 
     * all charts inherit this behavior.
     *
     * @polymerBehavior
    **/
    epiviz.ChartJSONBehavior = {
        properties : {

            /**
             * json data object.
             *
             * @type {Object} data
             * @property {Array<Object>} data.cols For each column, array of values.
             * @property {Array<Object>} data.rows For each row metadata, array of values. 
             * @property {Array<Object>} data.colAnnotation For each column, annotations if available
             */   
            data: {
                type: Object,
                notify: true
                // observer: '_dataChanged'
            },

            /**
             * Dimensions for a chart from data Object. (x and y axis measurements).
             *
             * @type {Array<string>}
             */            
            dimS: {
                type: Array,
                notify: true
                // observer: '_dimsChanged'
            },

            /**
             * Measurements for a chart from data Object.
             *
             * @type {Array<string>}
             */            
            measurements: {
                type: Array,
                notify: true
            },

            /**
             * json data Key.
             *
             * @type {string} 
             */  
            key: {
                type: String,
                notify: true
            },

            /**
             * Chart json data object.
             *
             * @type {Object}
             */   
            _chartData: {
                type: Object,
                notify: true
            }, 

            /**
             * Chart range. 
             *
             * @type {Object<epiviz.datatypes.GenomicRange>}
             */
            range: {
                type: Object,
                notify: true
            },

            /**
             * Chart json measurements object.
             *
             * @type {Object}
             */   
            _chartMeasurements: {
                type: Array,
                notify: true
            }
        },

        ready: function() {
            var self = this;
            self.plotId = this.$.epivizChart.plotId;

            var m = [];
            var mSet = new epiviz.measurements.MeasurementSet();
            var datasource = "epiviz";

            var rowLength = 0;

            // if data format is a Array of JSON Objects (long format)
            if(Array.isArray(self.data)) {
                var rowKeys = Object.keys(self.data[0]);
                var colAnnotation = null;
                var colsCollection = {}, cols = {};
                var rowLength = self.data.length;

                rowKeys.forEach(function(key) {
                    colsCollection[key] = self.data.map(function(r) { return r[key];});
                });

                var rowMetadata = rowKeys.slice(0);
                var rows = Object.assign({}, colsCollection);

                self.dimS.forEach(function(dim) {
                    var index = rowMetadata.indexOf(dim);
                    rowMetadata.splice(index, 1);
                    delete rows[dim];
                    cols[dim] = colsCollection[dim];
                });

                self.dimS.forEach(function(dim) {
                    var colValues = cols[dim];
                    m.push({
                        'id': dim,
                        'name': dim,
                        'type': 'feature',
                        'datasourceId': datasource,
                        'datasourceGroup': dim,
                        'dataprovider': datasource,
                        'formula': null,
                        'defaultChartType': self.chartName,
                        'annotation': colAnnotation,
                        'minValue': Math.min.apply(Math, colValues),
                        'maxValue': Math.max.apply(Math, colValues),
                        'metadata': rowMetadata
                    });

                    mSet.add(new epiviz.measurements.Measurement(
                        dim, dim, 'feature', datasource, dim, datasource, null, self.chartName, colAnnotation, null, null, rowMetadata
                    ));
                });

                self._chartMeasurements = m;

                /**
                 *  Must have fields
                 *  jsondata.cols
                 *  jsondata.rows
                 *  jsondata.rows.metadata (label)
                 */
                var jsonData = {};
                jsonData.cols = cols;
                jsonData.globalStartIndex = 1;
                var rowObj = self._generateRowIndexes(rowLength);
                rowObj.metadata = rows;
                jsonData.rows = rowObj;
            }
            else {
                //if data format is more like a dataframe/data table representation
                var rowMetadata = Object.keys(self.data.rows);
                var rowLength = self.data.cols[Object.keys(self.data.cols)[0]].length;

                if(self.measurements) {
                    self.measurements.forEach(function(mea) {
                        mSet.add(mea);
                    })

                    m = self.measurements;
                }
                else if(self.dimS) {
                    self.dimS.forEach(function(dim) {

                        var colValues = [0,5];
                        if(self.data.cols) {
                            colValues = self.data.cols[dim] || self.data.cols[dim].values;
                        }
                        // var colValues = self.data.cols[dim];
                        var rowLength = colValues.length;

                        m.push({
                            'id': dim,
                            'name': dim,
                            'type': 'feature',
                            'datasourceId': datasource,
                            'datasourceGroup': dim,
                            'dataprovider': datasource,
                            'formula': null,
                            'defaultChartType': self.chartName,
                            'annotation': undefined,
                            'minValue': Math.min.apply(Math, colValues),
                            'maxValue': Math.max.apply(Math, colValues),
                            'metadata': rowMetadata
                        });

                        mSet.add(new epiviz.measurements.Measurement(
                            dim, dim, 'feature', datasource, dim, datasource, null, self.chartName, undefined, null, null, rowMetadata
                        ));
                    });
                }

                self._chartMeasurements = m;
                var jsonData = {};
                jsonData.cols = {};
                var colKeys = Object.keys(self.data.cols);

                colKeys.forEach(function(ck) {
                    if(Array.isArray(self.data.cols[ck])) {
                        jsonData.cols[ck] = self.data.cols[ck];
                    }
                    else {
                        jsonData.cols[ck] = self.data.cols[ck]["values"];
                    }
                });

                var rowObj;
                var rowKeys = Object.keys(self.data.rows);

                if( (rowKeys.indexOf("start") == -1) || (rowKeys.indexOf("index") == -1) || (rowKeys.rows.indexOf("end") == -1)) {
                    rowObj = self._generateRowIndexes(rowLength);
                    rowObj.metadata = self.data.rows;
                }
                else {
                    rowObj.start = self.data.rows.start;
                    rowObj.end = self.data.rows.end;
                    rowObj.index = self.data.rows.index;
                    rowObj.metadata = self.data.rows.metadata;
                }

                jsonData.globalStartIndex = rowObj.start[0];
                jsonData.rows = rowObj;
            }

            var chartData = new epiviz.measurements.MeasurementHashtable();
            var sumExp = new epiviz.datatypes.PartialSummarizedExperiment();
            var globalStartIndex = jsonData.globalStartIndex;
            var range =  new epiviz.datatypes.GenomicRange(datasource, 1, rowLength-1);
            self._chartRange = range;
            
            var rowDataObj = new epiviz.datatypes.GenomicRangeArray(datasource, range, globalStartIndex, jsonData.rows);
            sumExp.addRowData(rowDataObj);

            mSet.foreach(function(m) {
                var valueData = new epiviz.datatypes.FeatureValueArray(m, range, globalStartIndex, jsonData.cols[m.id()]);
                sumExp.addValues(valueData);
            });

            mSet.foreach(function(m) {
                var msData = new epiviz.datatypes.MeasurementGenomicDataWrapper(m, sumExp);
                chartData.put(m, msData);
            });

            var genomicData = new epiviz.datatypes.MapGenomicData(chartData);
            self._chartData = genomicData;
        },

        _generateRowIndexes: function(length) {
            var rowObj = {};
            rowObj.start = [];
            rowObj.index = [];
            rowObj.end = [];
            for(var i=0; i< length; i++) {
                rowObj.start.push(i+1);
                rowObj.index.push(i+1);
                rowObj.end.push(i+2);
            }
            return rowObj;
        }
    }
</script><dom-module id="epiviz-json-heatmap-plot">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <epiviz-heatmap-plot id="epivizChart" range="{{_chartRange}}" data="{{_chartData}}" measurements="{{_chartMeasurements}}"></epiviz-heatmap-plot>
    
    </template>

    <script>

        Polymer({
            /* Custom element html tag */
            is: 'epiviz-json-heatmap-plot',
            behaviors: [epiviz.ChartJSONBehavior],

            properties: {
                /**
                 * Chart Name. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                chartName: {
                    type: String,
                    value: "Heatmap Plot"
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {
                var self = this;
                
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.$.epivizChart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.$.epivizChart.unHover();
                }.bind(self));
            }

            /* callback function after the element is initialized */
            // ready: function() {}
        });
    </script>
</dom-module><dom-module id="epiviz-json-line-plot">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <epiviz-line-plot id="epivizChart" range="{{_chartRange}}" data="{{_chartData}}" measurements="{{_chartMeasurements}}"></epiviz-line-plot>
    
    </template>

    <script>

        Polymer({
            /* Custom element html tag */
            is: 'epiviz-json-line-plot',
            behaviors: [epiviz.ChartJSONBehavior],

            properties: {
                /**
                 * Chart Name. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                chartName: {
                    type: String,
                    value: "Line Plot"
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {
                var self = this;
                
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.$.epivizChart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.$.epivizChart.unHover();
                }.bind(self));
            }

            /* callback function after the element is initialized */
            // ready: function() {}
        });
    </script>
</dom-module><dom-module id="epiviz-json-line-track">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 900px;
                min-height: 90px;
                display: inline-block;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <epiviz-line-track id="epivizChart" range="{{_chartRange}}" data="{{_chartData}}" measurements="{{_chartMeasurements}}"></epiviz-line-track>
    
    </template>

    <script>

        Polymer({
            /* Custom element html tag */
            is: 'epiviz-json-line-track',
            behaviors: [epiviz.ChartJSONBehavior],

            properties: {
                /**
                 * Chart Name. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                chartName: {
                    type: String,
                    value: "Line Track"
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {
                var self = this;
                
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.$.epivizChart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.$.epivizChart.unHover();
                }.bind(self));
            }

            /* callback function after the element is initialized */
            // ready: function() {}
        });
    </script>
</dom-module><dom-module id="epiviz-json-scatter-plot">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <epiviz-scatter-plot id="epivizChart" range="{{_chartRange}}" data="{{_chartData}}" measurements="{{_chartMeasurements}}"></epiviz-scatter-plot>
    
    </template>

    <script>

        Polymer({
            /* Custom element html tag */
            is: 'epiviz-json-scatter-plot',
            behaviors: [epiviz.ChartJSONBehavior],

            properties: {
                /**
                 * Chart Name. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                chartName: {
                    type: String,
                    value: "Scatter Plot"
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {
                var self = this;
                
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.$.epivizChart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.$.epivizChart.unHover();
                }.bind(self));
            }

            /* callback function after the element is initialized */
            // ready: function() {}
        });
    </script>
</dom-module><dom-module id="epiviz-json-stacked-line-track">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 900px;
                min-height: 90px;
                display: inline-block;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <epiviz-stacked-line-track id="epivizChart" range="{{_chartRange}}" data="{{_chartData}}" measurements="{{_chartMeasurements}}"></epiviz-stacked-line-track>
    
    </template>

    <script>

        Polymer({
            /* Custom element html tag */
            is: 'epiviz-json-stacked-line-track',
            behaviors: [epiviz.ChartJSONBehavior],

            properties: {
                /**
                 * Chart Name. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                chartName: {
                    type: String,
                    value: "Stacked Line Track"
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {
                var self = this;
                
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.$.epivizChart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.$.epivizChart.unHover();
                }.bind(self));
            }

            /* callback function after the element is initialized */
            // ready: function() {}
        });
    </script>
</dom-module><dom-module id="epiviz-json-stacked-line-plot">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <epiviz-stacked-line-plot id="epivizChart" range="{{_chartRange}}" data="{{_chartData}}" measurements="{{_chartMeasurements}}"></epiviz-stacked-line-plot>
    
    </template>

    <script>

        Polymer({
            /* Custom element html tag */
            is: 'epiviz-json-stacked-line-plot',
            behaviors: [epiviz.ChartJSONBehavior],

            properties: {
                /**
                 * Chart Name. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                chartName: {
                    type: String,
                    value: "Stacked Line Plot"
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {
                var self = this;
                
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.$.epivizChart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.$.epivizChart.unHover();
                }.bind(self));
            }

            /* callback function after the element is initialized */
            // ready: function() {}
        });
    </script>
</dom-module><dom-module id="epiviz-json-blocks-track">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                min-width: 400px;
                min-height: 400px;
                display: inline-block;
                margin: 10px;
            }
        </style>

        <!-- local DOM goes here -->
        <epiviz-blocks-track id="epivizChart" range="{{_chartRange}}" data="{{_chartData}}" measurements="{{_chartMeasurements}}"></epiviz-blocks-track>
    </template>
    
    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-json-blocks-track',
            behaviors: [epiviz.ChartJSONBehavior],

            properties: {
                /**
                 * Chart Name. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                chartName: {
                    type: String,
                    value: "Blocks Track"
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is attached to the DOM */
            attached: function() {
                var self = this;
                
                var parent = self.parentNode;

                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.$.epivizChart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.$.epivizChart.unHover();
                }.bind(self));
            }

            /* callback function after the element is initialized */
            // ready: function() {}
        });
    </script>
</dom-module><link rel="import" href="../paper-autocomplete/paper-autocomplete.html">
<dom-module id="epiviz-navigation">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
                width: auto;
                height: auto;
            }

            .container {
                width: 600px;
                display: inline;
            }

            .flex {
                @apply(--layout-horizontal);
                align-items: center;
            }

            .flexchild {
                @apply(--layout-flex);
                padding: 10px;
                flex: 1 1 auto;
            }

            .flex-end-justified {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
            }

            paper-icon-button {
                background-color: #dedede;
                color: black;
                border-radius: 3px;
                padding: 2px;
                width: 28px;
                height: 28px;
            }
        </style>

        <!-- local DOM goes here -->
        <div>
            <button class="collapse-header" on-click="toggleHeader">Collapse</button>
            <button on-click="cloneNavigation">Clone</button>
        </div>
        <template restamp="true" is="dom-if" if="{{!collapsed}}">
            <epiviz-ideogram-track gene-in-range="{{geneInRange}}" id="navTrack" chromosome="{{chr}}" start="{{start}}" end="{{end}}"></epiviz-ideogram-track>
        </template>
        
        <iron-collapse id="navHeader">
            <template restamp="true" is="dom-if" if="{{collapsed}}">
                <div class="container flex">
                    <div class="flexchild">
                        <paper-icon-button title="move left" icon="icons:chevron-left" on-click="moveLeft"></paper-icon-button>
                        <paper-icon-button title="move right" icon="icons:chevron-right" on-click="moveRight"></paper-icon-button>
                        <paper-icon-button title="zoom out" icon="icons:zoom-out" on-click="zoomOut"></paper-icon-button>
                        <paper-icon-button title="zoom in" icon="icons:zoom-in" on-click="zoomIn"></paper-icon-button>
                    </div>
                    <div class="flexchild">
                        <paper-input value="{{_strRange]]" label="Chromosome Location" on-change="_updateStrRange"></paper-input>
                    </div>
                    <div class="flexchild">
                        <paper-autocomplete id="geneSearch" label="Search Gene/Probe" remote-source="true" min-length="2" on-autocomplete-selected="_selectGene" on-autocomplete-change="_searchGene" value-property="gene" text-property="gene">
                            <template autocomplete-custom-template="">
                                <paper-item on-tap="_onSelect" id$="[[_getSuggestionId(index)]]" role="option" aria-selected="false">
                                <div>[[item.gene]] [[item.seqName]]: [[item.start]] - [[item.end]]</div>
                                <paper-ripple></paper-ripple>
                                </paper-item>
                            </template>
                        </paper-autocomplete>
                    </div>
                </div>
                <content id="chartNav" select=".charts"></content>
            </template>
        </iron-collapse>
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-navigation',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartDataBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Chromosome location.
                 * Default Location Attribute to set to all the children chart elements.
                 *
                 * @example: chr1
                 *
                 * @type {string}
                 */
                chr: {
                    type: String
                    // notify: true
                },

                /**
                 * Chromosome start. 
                 * Default Chromosome start value to use. (defaults to 0).
                 *
                 * @type {number}
                 */
                start: {
                    type: Number
                    // notify: true
                },

                /**
                 * Chromosome end. 
                 * Default Chromosome end value to use. (defaults to the `<chr>` length).
                 *
                 * @type {number}
                 */
                end: {
                    type: Number
                    // notify: true
                },

                /**
                 * Updates location attributes(chr, start, end) to this gene's location.
                 *
                 * @type {string}
                 */
                gene: {
                    type: String,
                    observer: '_geneUpdate'
                },

                /**
                 * Computed Range from `<chr>`, `<start>` & `<end>`. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                range: {
                    type: Object,
                    // notify: true,
		            computed: 'getGenomicRange(chr, start, end)',
                    observer: '_rangeUpdate'
                },

                /**
                 * Computed Range from `<chr>`, `<start>` & `<end>`. 
                 *
                 * @type {string}
                 */        
                _strRange: {
                    type: String,
                    notify: true,
		            computed: 'getStrRange(chr, start, end)'
                },

                /**
                 * Default scroll left/right ratio
                 *
                 * @type {number}
                 */   
                stepRatio: {
                    type: Number,
                    notify: true,
                    value: 0.2
                },

                /**
                 * Default zoom in/out ratio
                 *
                 * @type {number}
                 */   
                zoomRatio: {
                    type: Number,
                    notify: true,
                    value: 0.2
                },

                /**
                 * Whether the element is collapsed
                 *
                 * @type {boolean}
                 */   
                collapsed: {
                    type: Boolean,
                    notify: true,
                    value: false
                },

                /**
                 * Current gene in range (set automatically)
                 *
                 * @type {string}
                 */   
                geneInRange: {
                    type: String,
                    notify: true
                },

                /**
                 * Default chart properties for navigation element.
                 *
                 * @type {Object}
                 */  
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {
                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,
                            colorPalettes: [],
                            maxSearchResults: 12
                        };
                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            /* event listeners */
            listeners: {
                'hover': 'onHover',
                'unHover': 'onUnhover'
            },

            /**
             * Toggle handler (expand/collapse)
             */
            toggleHeader: function(event) {
                this.$.navHeader.toggle();
                this.collapsed = !this.collapsed;
                console.log($(this).find(".collapse-header")[0]);
                if (this.collapsed) {
                    $(this).find(".collapse-header")[0].innerHTML = "Collapse";
                } else {
                    $(this).find(".collapse-header")[0].innerHTML = "Expand";
                }
                event.preventDefault();
                event.stopPropagation();
                // if(!this.collapsed) {
                //     this._getGenesInRange(this, this);
                // }
                // 
                // this._getData();
            },

            /**
             * Hover event handler.
             * Listens to hover events fired from its children elements and propagates to other charts.
             *
             * @fires hoverAllCharts
             */
            onHover: function(e) {
                /**
                 * Propogates hover event to other charts.
                 *
                 * @event hoverAllCharts
                 * @type {object}
                 * @property {object} data - data object currently hovered.
                 */
                this.fire('hoverAllCharts', {
                    data: e.detail.data
                });
            },

            /**
             * Unhover event handler.
             * Listens to unhover events fired from its children elements and propagates to other charts
             * 
             * @fires unHoverAllCharts
             */
            onUnhover: function(e) {
                /**
                 * Propogates unHover event to other charts.
                 *
                 * @event unHoverAllCharts
                 */
                this.fire('unHoverAllCharts', {
                    data: null
                });
            },

            /**
             * ChartLocation/RangeChange event handler.
             */
            _rangeUpdate: function() {
                var self = this;

                self._getGenesInRange(self, self);
                
                var numChildren = self.getEffectiveChildren().length;
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild == undefined || currentChild.plotId == undefined) {return ;}
                    currentChild.range = self.range;
                    if(Polymer.dom(self).parentNode.nodeName === "EPIVIZ-ENVIRONMENT") {
                        self._getElementData(currentChild, self, self.parentNode.measurements);  
                    }
                }
            },

            /**
             * GeneLocationChange event handler.
             */
            _geneUpdate: function() {
                var self = this;
                self._getElementSearch(self.gene, null, null, function(data) {
                    self.chr = data[0].seqName;
                    self.start = data[0].start;
                    self.end = data[0].end;
                });
            },

            /**
             * Search handler for a gene (gene search field).
             * 
             * @param {string} keyword search string is at e.detail.option.text
             */
            _searchGene: function(e) {
                var self = this;
                var gene = e.detail.option.text;
                var field = this.$$("#geneSearch");

                if (self.useDefaultDataProvider) {

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);
                    var dataProviderFactory = new epiviz.data.DataProviderFactory(new epiviz.Config(self.configSrc));
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.search(function(data) {
                        field.suggestions(data);
                    }, gene);
                }
                else {
                    if(Polymer.dom(self).parentNode.nodeName === "EPIVIZ-ENVIRONMENT") {
                        var result = self._getElementSearch(gene, self, self);  
                    }
                }
            },

            /**
             * Update Location Attributes when a gene is selected.
             * selected gene value @ e.detail.option
             */
            _selectGene: function(e) {
                var selected= e.detail.option;

                this.chr = selected.seqName;
                this.start = selected.start - Math.round(selected.start * 0.01);
                this.end = selected.end + Math.round(selected.end * 0.01);
            },

            /**
             * Handles location change (gene location field)
             */
            _updateStrRange: function(e) {
                var update = e.target.value;
                var split = update.split(":");
                var chr = split[0];
                var rsplit = split[1].split("-");
                var start = parseInt(rsplit[0]);
                var end = parseInt(rsplit[1]);

                this.chr = chr;
                this.start = start;
                this.end = end;
            },

            /**
             * Navigation handler - move left
             */
            moveLeft: function(e) {
                var width = this.end - this.start;
                var newStart = this.start - Math.round(width * this.stepRatio);
                var newEnd = newStart + width;
                
                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
            },

            /**
             * Navigation handler - move right
             */
            moveRight: function(e) {
                var width = this.end - this.start;
                var newStart = this.start + Math.round(width * this.stepRatio);
                var newEnd = newStart + width;

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
            },

            /**
             * Navigation handler - zoom in 
             */
            zoomIn: function(e) {
                var width = Math.round(this.end - this.start);
                var mid = Math.round(this.start + (width/2));
                var newWidth = Math.round(width * (1 - this.zoomRatio));
                var newStart = Math.round(mid - (newWidth * 0.5));
                var newEnd = Math.round(this.start + newWidth);

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
            },

            /**
             * Navigation handler - zoom out
             */
            zoomOut: function(e) {
                var width = Math.round(this.end - this.start);
                var mid = Math.round(this.start + (width/2));
                var newWidth = Math.round(width * (1 + this.zoomRatio));
                var newStart = Math.round(mid - (newWidth * 0.5));
                var newEnd = Math.round(this.start + newWidth);

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
            },

            /**
             * String formatted Range
             * 
             * @param {string} chr chromosome location
             * @param {number} start chromosome start
             * @param {number} end chromosome end
             *
             * @return {string} range in string format
             */
            getStrRange: function(chr, start, end) {
                return chr + ": " + start + " - " + end;
            },

            /**
             * String formatted Range
             * 
             * @param {string} chr chromosome location
             * @param {number} start chromosome start
             * @param {number} end chromosome end
             *
             * @return {epiviz.datatypes.GenomicRange} Genomic Range object
             */
            getGenomicRange: function(chr, start, end) {
                    return new epiviz.datatypes.GenomicRange(chr, start, end-start);
            },

            /**
             * Handles data when charts are first initialized.
             */
            _getData: function() {
                var self = this;
                var numChildren = self.getEffectiveChildren().length;
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild == undefined || currentChild.plotId == undefined) {return ;}
                    currentChild.range = self.range;
                    if(Polymer.dom(self).parentNode.nodeName === "EPIVIZ-ENVIRONMENT") {
                        self._getElementData(currentChild, self, self.parentNode.measurements);  
                    }
                }
            },

            /**
             * Clones a navigation element and add it to the page
             */
            cloneNavigation: function() {
                var self = this;

                var navElem = document.createElement('epiviz-navigation');
                navElem.chr = self.chr;
                navElem.start = self.start;
                navElem.end = self.end;
                navElem.className = "charts";

                Polymer.dom(self.parentNode).appendChild(navElem);

                var numChildren = self.getEffectiveChildren().length;
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    var childElem = document.createElement(currentChild.nodeName);
                    childElem.className = "charts";
                    childElem.dimS = currentChild.dimS;
                    childElem.measurements = currentChild.measurements;
                    childElem.chartSettings = currentChild.chartSettings;
                    childElem.chartColors = currentChild.chartColors;

                    Polymer.dom(navElem).appendChild(childElem);
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},
            
            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;
                parent.addEventListener('hoverAllCharts', function(e) {
                    if(!self.collapsed) {
                        if(self.$$("#navTrack").chartObject.overlapsWith(e.detail.data)) {
                            self.$$("#navTrack").hover();
                        }
                    }
                    else {
                        var numChildren = self.getEffectiveChildren().length;
                        for (var index = 0; index < numChildren; index++) {
                            var currentChild = self.getEffectiveChildren()[index];
                            currentChild.hover(e.detail.data);
                        }
                    }
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    if(!self.collapsed) {
                        self.$$("#navTrack").unHover();
                    }
                    else {
                        var numChildren = self.getEffectiveChildren().length;
                        for (var index = 0; index < numChildren; index++) {
                            var currentChild = self.getEffectiveChildren()[index];
                            currentChild.unHover();
                        }
                    }
                }.bind(self));

                // if(self.collapsed) {
                    var numChildren = self.getEffectiveChildren().length;
                    for (var index = 0; index < numChildren; index++) {
                        var currentChild = self.getEffectiveChildren()[index];
                        currentChild.range = self.range;
                        self._getElementData(currentChild, self, self.parentNode.measurements);
                    }
                // }

                if (self.useDefaultDataProvider) {

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(new epiviz.Config(self.configSrc));
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getSeqInfos(function(data) {
                        var seqinfo = {};
                        data.forEach(function(s) {
                            seqinfo[s.seqName] = s;
                        });
                        self.seqInfo = seqinfo;
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;

                self.plotId = self.plotId || self._generatePlotId();
                self.config = new epiviz.Config(self.configSrc);

                if(self.gene) {
                    self._getElementSearch(self.gene, null, null, function(data) {
                        self.chr = data[0].seqName;
                        self.start = data[0].start;
                        self.end = data[0].end;
                        self.range = self.getGenomicRange(self.chr, self.start, self.end);
                    });
                }
                else if(self.chr && self.start && self.end) {
                    self.range = self.getGenomicRange(self.chr, self.start, self.end);
                }

                if(self.transformDataFunc) {
                    self.transformFunc = new Function('return ' + self.transformDataFunc);
                }
                else {
                    self.transformFunc = self.epivizToJSON;
                }
            },

            /**
             * Creates an instance of the navigation element.
             *
             * @return {null} for consistency with other chart elements
             */
            _createChart: function() {
                return null;
            }
        });
    </script>
</dom-module><script>
    /**
     * `ChartWorkspaceBehavior` is an interface to saving & workspaces. 
     * all charts inherit this behavior.
     *
     * @polymerBehavior
    **/
    epiviz.ChartWorkspaceBehavior = {
        properties : {

            /**
             * current workspace object.
             *
             * @type {Object}
             */   
            workspace: {
                type: Object,
                notify: true
                // observer: 'loadWorkspace'
            },

            /**
             * current workspace name.
             *
             * @type {String}
             */   
            workspaceName: {
                type: String,
                notify: true,
                value: "default"
            }
        },

        // ready: function() {},

        loadWorkspace: function(workspace) {

            var self = this;
            
            self.measurements = self.workspace.measurements;
            self.chr = self.workspace.chr;
            self.start = self.workspace.start;
            self.end = self.workspace.end;
            self.plotId = self.workspace.plotId;
            
            for (var key in self.workspace.children) {
                chartWorkspaceObj = self.workspace.children[key];

                var chart = document.createElement(chartWorkspaceObj.node);
                chart.className = "charts";
                if(chartWorkspaceObj.node == "EPIVIZ-NAVIGATION") {
                    chart.chr = chartWorkspaceObj.chr;
                    chart.start = chartWorkspaceObj.start;
                    chart.end = chartWorkspaceObj.end;
                    chart.node = chartWorkspaceObj.nodeName;

                    Polymer.dom(self).appendChild(chart);

                    for (var navs in chartWorkspaceObj.children) {
                        var chartNavWorkspaceObj = chartWorkspaceObj.children[navs];
                        var navChart = document.createElement(chartNavWorkspaceObj.node);

                        navChart.className = "charts";
                        navChart.measurements = chartNavWorkspaceObj.measurements;
                        navChart.dimS = chartNavWorkspaceObj.dims;
                        navChart.chartSettings = chartNavWorkspaceObj.chartSettings;
                        navChart.chartColors = chartNavWorkspaceObj.chartColors;

                        Polymer.dom(chart).appendChild(navChart);
                    }
                }
                else {
                    chart.measurements = chartWorkspaceObj.measurements;
                    chart.dimS = chartWorkspaceObj.dims;
                    chart.chartSettings = chartWorkspaceObj.chartSettings;
                    chart.chartColors = chartWorkspaceObj.chartColors;
                    Polymer.dom(self).appendChild(chart);
                }
            }
        },

        saveWorkspace: function() {

            var self = this;

            var workspaceObj = {};
            workspaceObj.measurements = self.measurements;
            workspaceObj.plotId = self.plotId;
            workspaceObj.chr = self.chr;
            workspaceObj.start = self.start;
            workspaceObj.end = self.end;
            workspaceObj.children = {};

            var numChildren = self.getEffectiveChildren().length;
            for (var index = 0; index < numChildren; index++) {

                var childObj = {};
                var currentChild = self.getEffectiveChildren()[index];
                childObj[currentChild.plotId] = {};

                if(currentChild.nodeName === "EPIVIZ-NAVIGATION") {

                    childObj[currentChild.plotId].chr = currentChild.chr;
                    childObj[currentChild.plotId].start = currentChild.start;
                    childObj[currentChild.plotId].end = currentChild.end;
                    childObj[currentChild.plotId].node = currentChild.nodeName;
                    childObj[currentChild.plotId].children = {};

                    var navChildren = currentChild.getEffectiveChildren().length;
                    for (var nindex = 0; nindex < navChildren; nindex++) {
                        var currentNavChild = currentChild.getEffectiveChildren()[nindex];
                        childObj[currentChild.plotId].children[currentNavChild.plotId] = {
                            "node": currentNavChild.nodeName,
                            "measurements": currentNavChild.measurements,
                            "dims": currentNavChild.dimS,
                            "chartSettings": currentNavChild.chartSettings,
                            "chartColors": currentNavChild.chartColors
                        }
                    }
                }
                else {
                    childObj[currentChild.plotId] = {
                        "node": currentChild.nodeName,
                        "measurements": currentChild.measurements,
                        "dims": currentChild.dimS,
                        "chartSettings": currentChild.chartSettings,
                        "chartColors": currentChild.chartColors
                    };
                }
                workspaceObj.children[currentChild.plotId] = childObj[currentChild.plotId];
            }
            self.workspace = workspaceObj;

            self.fire('workspaceChanged', {
                id: self.plotId,
                data: self.workspace 
            });
        }
    }
</script><dom-module id="epiviz-environment">

    <template>	
        <style>
            :host{
                display: inline-block;
                padding: 15px;
                margin: 5px;
                border: 1px solid black;
                border-radius: 5px;
                min-width: 400px;
                min-height: 400px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
                width: auto;
                height: auto;
            }
        </style>

    <div class="header">
        <a href="http://epiviz.github.io" target="_blank"><img src="epiviz_4_logo_medium.png" alt="Epiviz" width="100" height="21"></a>
    </div>
    <!--<content id="chartNav" select=".navigation"></content>-->
    <content id="chartEnv" select=".charts"></content>
</template>

    <script>
        Polymer({
            is: 'epiviz-environment',
            behaviors: [epiviz.ChartDataBehavior, epiviz.ChartWorkspaceBehavior],

            properties: {
                
                /**
                 * Measurement Object mapped to measurements provided from `<epiviz-data-source>`.
                 *
                 * @type {Object}
                 */
                measurements: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true
                },

                /**
                 * Chromosome location.
                 * Default Location Attribute to set to all the children chart elements.
                 *
                 * @example: chr1
                 *
                 * @type {string}
                 */
                chr: {
                    type: String,
                    notify: true
                },

                /**
                 * <Optional> Chromosome start. 
                 * Default Chromosome start value to use. (defaults to 0).
                 *
                 * @type {number}
                 */
                start: {
                    type: Number,
                    notify: true
                },

                /**
                 * <Optional> Chromosome end. 
                 * Default Chromosome end value to use. (defaults to the `<chr>` length).
                 *
                 * @type {number}
                 */
                end: {
                    type: Number,
                    notify: true
                },

                /**
                 * Computed Range from `<chr>`, `<start>` & `<end>`. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                range: {
                    type: Object,
                    notify: true,
		            computed: 'getGenomicRange(chr, start, end)'
                },

                /**
                 * Intiliazes an environment with `<epiviz-navigation>` elements.
                 * 
                 * Can be one of these {region: {chr , start, end}} or {gene} 
                 *
                 * @example: [{region: {chr: 'chr11', start: 20000, end: 600000}{, {gene: 'esr1'}]
                 * 
                 * @type {Array[<Object>]}
                 */
                initializeRegions: {
                    type: Array,
                    value: []
                }
            },

            observers: [
                '_rangeChanged(chr.*, start.*, end.*)'
            ],

            // listeners: {
            //     'iron-resize': '_onResize',
            //     'transitionend': '_onResize'
            // },

            /**
             * Resizes the chart.
             */
            _onResize: function() {
                var self = this;
                // this._measurementsChanged();
                if(this.chart != null) {
                    // var width = self.offsetWidth - 40;
                    // if(width < self.chartType.defaultWidth()) { width = self.chartType.defaultWidth()}
                    this.chart._properties.width = self.offsetWidth - 20 - epiviz.ui.charts.Visualization.SVG_MARGIN;
                    this.chart._properties.height = self.offsetHeight - 20 - epiviz.ui.charts.Visualization.SVG_MARGIN;
                    this._draw();
                }
            },

            /**
             * Creates a epiviz GenomicRange object from chromosome, start and end.
             * 
             * @param {string} chr chromosome location 
             * @param {number} start chromosome start
             * @param {number} end chromosome end 
             * 
             * @return {epiviz.datatypes.GenomicRange}
             */
            getGenomicRange: function(chr, start, end) {
                return new epiviz.datatypes.GenomicRange(chr, start, end-start);
            },

            // Listeners for interaction between charts
            listeners: {
                'hover': 'onHover',
                'unHover': 'onUnhover',
                'dimChanged': 'onDimChanged'
            },

            /**
             * Hover event handler.
             * Listens to hover events fired from its children elements and propagates to other charts
             *
             * @fires hoverAllCharts
             */
            onHover: function(e) {

                /**
                 * Propogates hover event to other charts.
                 *
                 * @event hoverAllCharts
                 * @type {object}
                 * @property {object} data - data object currently hovered.
                 */
                this.fire('hoverAllCharts', {
                    data: e.detail.data
                });
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * Unhover event handler.
             * Listens to unhover events fired from its children elements and propagates to other charts
             * 
             * @fires unHoverAllCharts
             */
            onUnhover: function(e) {

                /**
                 * Propogates unHover event to other charts.
                 *
                 * @event unHoverAllCharts
                 */
                this.fire('unHoverAllCharts', {
                    data: null
                });
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * MeasurementChange/ChartDimension event handler.
             * Listens to when a chart dimensions(axes) are changed and updates chart
             */
            onDimChanged: function(e) {
                var chartId = e.detail.id;

                if (chartId != null) {
                    this._updateChart(chartId);
                }
            },

            /**
             * Generates a unique chart ID
             * 
             * @return {string}
             */
            _generatePlotId: function() {
                var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var result = '';
                var size = 7;

                for (var i = 0; i < size; ++i) {
                    result += chars[Math.round(Math.random() * (chars.length - 1))];
                }
                return 'epiviz-' + result;
            },

            /**
             * ChartLocation/RangeChange event handler.
             */
            _rangeChanged: function() {

                var self = this;

                var numChildren = self.getEffectiveChildren().length;
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild == undefined || currentChild.plotId == undefined) {return ;}
                    currentChild.range = self.range;
                    // self._updateChart(currentChild.plotId);  
                    self._getElementData(currentChild, self, self.measurements);
                }
            },

            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                if(!(self.start && self.end)) {
                    if(self.chr && self.seqInfo) {
                        self.start = 0;
                        self.end = self.seqInfo[self.chr].max;
                    }
                }

                if(self.initializeRegions.length > 0) {
                    for(var i=0; i< self.initializeRegions.length; i++) {
                        var navElem = document.createElement("epiviz-navigation");
                        navElem.className = "charts";
                        if(Object.keys(self.initializeRegions[i]).indexOf("gene") != -1) {
                            navElem.gene = self.initializeRegions[i].gene;
                        }
                        else {
                            navElem.chr = self.initializeRegions[i].region.chr;
                            navElem.start = self.initializeRegions[i].region.start;
                            navElem.end = self.initializeRegions[i].region.end;
                        }
                        Polymer.dom(self).appendChild(navElem);
                    }
                }

                if(self.measurements) {
                    var numChildren = self.getEffectiveChildren().length;
                    for (var index = 0; index < numChildren; index++) {
                        var currentChild = self.getEffectiveChildren()[index];

                        if(currentChild.nodeName === "EPIVIZ-NAVIGATION") {

                            self._getElementSeqInfo(currentChild, self);

                            if(currentChild.collapsed) {
                                var navChildren = currentChild.getEffectiveChildren().length;
                                for (var nindex = 0; nindex < navChildren; nindex++) {
                                    var currentNavChild = currentChild.getEffectiveChildren()[nindex];
                                    self._getElementData(currentNavChild, self, self.measurements);
                                }
                            }
                        }
                        else {
                            self._getElementData(currentChild, self, self.measurements);
                        }
                    }
                }

                self._observer =
                    Polymer.dom(self.$.chartEnv).observeNodes(function(info) {
                        info.addedNodes.forEach(function(node) {
                            // self._updateChart(node.plotId);
                            if(node.nodeName === "EPIVIZ-NAVIGATION") {
                                self._getElementSeqInfo(node, Polymer.dom(self));

                                // if(node.collapsed) {
                                    var navChildren = node.getEffectiveChildren().length;
                                    for (var nindex = 0; nindex < navChildren; nindex++) {
                                        var currentNavChild = node.getEffectiveChildren()[nindex];
                                        self._getElementData(currentNavChild, self, self.measurements);
                                    }
                                // }
                            }
                            else {
                                self._getElementData(node, self, self.measurements);
                            }
                        });

                        self.saveWorkspace();
                    });
            },

            /* callback function after the element is initialized & attached */
            ready: function() {
                // this.scopeSubtree(this, true);
                var self = this;

                self.plotId = self.plotId || self._generatePlotId();

                if(self.transformDataFunc) {
                    self.transformFunc = new Function('return ' + self.transformDataFunc);
                }
                else {
                    self.transformFunc = self.epivizToJSON;
                }

                self._getElementSeqInfo(self, self);

                if(self.workspace) {
                    self.loadWorkspace(self.workspace);
                }
            }
        });
    </script>
</dom-module></div></body></html>