<!-- Polymer dependency -->
<link rel="import" href="../polymer/polymer.html">

<!-- Epiviz imports dependency -->
<link rel="import" href="../epiviz-imports/epiviz-common-js.html">
<!-- <link rel="import" href="../epiviz-imports/epiviz-common-css.html"> -->

<!-- Epiviz Polymer Behaviors dependency -->
<link rel="import" href="chart-data-behavior.html">
<link rel="import" href="chart-workspace-behavior.html">
<link rel="import" href="chart-add-behavior.html">
<link rel="import" href="chart-remove.html">

<!-- Polymer Elements -->
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-label/iron-label.html">

<!--
`<epiviz-environment>` is a wrapper element that manages measurements, handles events and brushing across all of its children `<epiviz-charts>` elements.

To use, add `<epiviz-environment>` in the page

      <epiviz-environment></epiviz-environment>

@demo demo/index-environment.html Example page showing a environment element with charts 
-->

<dom-module id="epiviz-environment">
    <template>
        <style>
            :host{
                display: inline-block;
                /* padding: 15px; */
                width: 99%;
                /* width: auto; */
                /* height: 100%; */
                margin: 10px;
                resize: both;
                border-radius: 5px;
                /* padding: 4px; */
                /* margin:5px; */
                transition:width 0.01s, height 0.01s;
                @apply(--shadow-elevation-2dp);
            }


            #chartSettingsContainer {
                position:absolute;
                top: 0;
                right: 0;
                border: 1px solid #000;
                border-radius: 2px;
                margin:1px;
            }

            .paper-header {
                background-color: #e0e2e2;
                padding-left: 5px;
            }

            #logo {
                vertical-align: middle;
            }


            paper-menu-button {
                float: right;
            }

            iron-label {
                color: #4285f4;
                font-weight: bold;
                font-size: 16px;
            }

            .isempty {
                position: relative;
                top: 50%;
                left: 50%;
                transform: translateX(-50%) translateY(-50%);
            }

            #header {
                height: 50px;
                /* linear-gradient(white, #e0e2e2) */
            }

            .content {
                min-height:200px;
                padding: 5px;
                display: grid;
                grid-template-columns: repeat(6, 1fr);
                grid-auto-rows: minmax(max-content, 100px);
                grid-row-gap: 2px;
                grid-column-gap: 2px;
            }

            ::content .grid-plot {
                grid-row: span 1;
                grid-column: span 2;
            }

            ::content .grid-track {
                grid-column: span 6;
                grid-row: span 1;
            }

            ::content .grid-navigation {
                grid-row: span 1;
                grid-column: span 6;
                order: 2;
            }

        </style>

            <div id="header" class="paper-header">
                <iron-label>EPIVIZ ENVIRONMENT</iron-label>
                <a href="http://epiviz.github.io" target="_blank" hidden$="[[noLogo]]">
                    <img id="logo" src="epiviz_4_logo_medium.png" alt="Epiviz" width="100" height="21">
                </a>
                <!-- <iron-dropdown> -->
                <!-- </iron-dropdown> -->

                <epiviz-add-chart id="addChart"></epiviz-add-chart> 
                <paper-menu-button dynamic-align vertical-align="bottom" vertical-offset=24>
                    <paper-icon-button icon="menu" class="dropdown-trigger"></paper-icon-button>
                    <paper-menu class="dropdown-content">
                        <paper-item>Delete</paper-item>
                        <paper-item>Clone</paper-item>
                    </paper-menu>
                </paper-menu-button>
            </div>
            <div id="chartContainer" class="content">
                <div class="isempty" hidden$="{{_isEmpty}}">Add a New Chart to the Workspace</div>
                <content id="chartEnv" select=".charts"></content>
            </div>
    </template>

    <script>
        Polymer({
            is: 'epiviz-environment',
            behaviors: [epiviz.ChartDataBehavior, epiviz.ChartWorkspaceBehavior, epiviz.ChartAddBehavior, Polymer.IronResizableBehavior],

            properties: {
                
                /**
                 * Measurement Object mapped to measurements provided from `<epiviz-data-source>`.
                 *
                 * @type {Object}
                 */
                measurements: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true
                },

                /**
                 * Chromosome location.
                 * Default Location Attribute to set to all the children chart elements.
                 *
                 * @example: chr1
                 *
                 * @type {string}
                 */
                chr: {
                    type: String,
                    notify: true,
                    value : "all"
                },

                /**
                 * <Optional> Chromosome start. 
                 * Default Chromosome start value to use. (defaults to 0).
                 *
                 * @type {number}
                 */
                start: {
                    type: Number,
                    notify: true,
                    value : null
                },

                /**
                 * <Optional> Chromosome end. 
                 * Default Chromosome end value to use. (defaults to the `<chr>` length).
                 *
                 * @type {number}
                 */
                end: {
                    type: Number,
                    notify: true,
                    value : null
                },

                /**
                 * Computed Range from `<chr>`, `<start>` & `<end>`. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                range: {
                    type: Object,
                    notify: true,
		            computed: 'getGenomicRange(chr, start, end)'
                },

                /**
                 * Intiliazes an environment with `<epiviz-navigation>` elements.
                 * 
                 * Can be one of these {region: {chr , start, end}} or {gene} 
                 *
                 * @example: [{region: {chr: 'chr11', start: 20000, end: 600000}{, {gene: 'esr1'}]
                 * 
                 * @type {Array[<Object>]}
                 */
                initializeRegions: {
                    type: Array,
                    value: []
                },

                /**
                 * List of regions currently in workspace
                 * 
                 * @type {Array}
                 */
                navigationRegions: {
                    type: Array,
                    notify: true,
                    value: []
                },

                /**
                 * Whether to show/hide the epiviz logo
                 *
                 * @type {boolean}
                 */  
                noLogo: {
                    type: Boolean,
                    notify: true,
                    reflectToAttribute: true,
                    value: false
                },

                /**
                 * Whether to use the default layout
                 *
                 * @type {boolean}
                 */  
                useLayout: {
                    type: Boolean,
                    notify: true,
                    reflectToAttribute: true,
                    value: true
                },

                /**
                 * Whether the element has no children
                 *
                 * @type {boolean}
                 */   
                 _isEmpty: {
                    type: Boolean,
                    notify: true,
                    value: function () {
                        return false;
                    }
                }
            },

            observers: [
                '_rangeChanged(chr.*, start.*, end.*)',
                '_navigationRegionsChanged(navigationRegions.*)'
            ],

            // Listeners for interaction between charts
            listeners: {
                'navigationRangeUpdate': '_updateNavRegion',
                'hover': 'onHover',
                'unHover': 'onUnhover',
                'select': 'onSelect',
                'deSelect': 'onDeSelect',
                'dimChanged': 'onDimChanged',
                // 'iron-resize': '_onResize',
                'navWorkspaceChanged': '_childWorkspaceChanged',
                // 'transitionend': '_onResize'
            },

            _updateNavRegion: function(e) {

                for(var regIndex = 0; regIndex < this.navigationRegions.length; regIndex++) {
                    // nRegions.push(this.navigationRegions[regIndex]["range"]);
                    if(e.detail.plotId == this.navigationRegions[regIndex]["plotId"]
                            && (e.detail.range != this.navigationRegions[regIndex]["range"])
                            ) {
                        this.navigationRegions.splice(regIndex, 1);
                        this.push("navigationRegions", {"plotId": e.detail.plotId, "range": e.detail.range});
                    }
                }
            },

            _childWorkspaceChanged: function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.saveWorkspace();
            },

            /**
             * Resizes the chart.
             */
            _onResize: function() {
                // console.log("env resize");
                var self = this;
                var numChildren = self.getEffectiveChildren().length;
                if(numChildren > 0) {self.set('_isEmpty', true);}
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild.nodeName.indexOf("-JSON-") != -1) {
                        currentChild.$.epivizChart._onResize();
                    }
                    else {
                        currentChild._onResize();
                    }
                }
            },

            /**
             * Creates a epiviz GenomicRange object from chromosome, start and end.
             * 
             * @param {string} chr chromosome location 
             * @param {number} start chromosome start
             * @param {number} end chromosome end 
             * 
             * @return {epiviz.datatypes.GenomicRange}
             */
            getGenomicRange: function(chr, start, end) {
                return new epiviz.datatypes.GenomicRange(chr, start, end-start);
            },

            _navigationRegionsChanged: function() {
                var self = this;
                // console.log(this.navigationRegions);
                if(this.navigationRegions && this.navigationRegions.length > 0) {
                    // this.fire('navigationRegions', {
                    //     data: this.navigationRegions
                    // });

                    var nRegions = [];

                    for(var regIndex = 0; regIndex < this.navigationRegions.length; regIndex++) {
                        nRegions.push(this.navigationRegions[regIndex]["range"]);
                    }

                    var numChildren = self.getEffectiveChildren().length;
                    if(numChildren > 0) {self.set('_isEmpty', true);}
                    for (var index = 0; index < numChildren; index++) {
                        var currentChild = self.getEffectiveChildren()[index];
                        if(currentChild.nodeName === "EPIVIZ-SCATTER-PLOT") {
                            currentChild.colorByRegions = nRegions;
                        }
                    }
                }
            },

            /**
             * Hover event handler.
             * Listens to hover events fired from its children elements and propagates to other charts
             *
             * @fires hoverAllCharts
             */
            onHover: function(e) {

                /**
                 * Propogates hover event to other charts.
                 *
                 * @event hoverAllCharts
                 * @type {object}
                 * @property {object} data - data object currently hovered.
                 */
                this.fire('hoverAllCharts', {
                    data: e.detail.data
                });
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * Unhover event handler.
             * Listens to unhover events fired from its children elements and propagates to other charts
             * 
             * @fires unHoverAllCharts
             */
            onUnhover: function(e) {

                /**
                 * Propogates unHover event to other charts.
                 *
                 * @event unHoverAllCharts
                 */
                this.fire('unHoverAllCharts', {
                    data: null
                });
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * select event handler.
             * Listens to select events fired from its children elements and propagates to other charts
             * 
             * @fires selectAllCharts
             */
             onSelect: function(e) {

                /**
                 * Propogates select event to other charts.
                 *
                 * @event selectAllCharts
                 */
                this.fire('selectAllCharts', {
                    data: e.detail.data
                });
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * deSelect event handler.
             * Listens to deSelect events fired from its children elements and propagates to other charts
             * 
             * @fires unSelectAllCharts
             */
             onDeSelect: function(e) {

                /**
                 * Propogates select event to other charts.
                 *
                 * @event unSelectAllCharts
                 */
                this.fire('unSelectAllCharts', {
                    data: null
                });
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * MeasurementChange/ChartDimension event handler.
             * Listens to when a chart dimensions(axes) are changed and updates chart
             */
            onDimChanged: function(e) {
                var chartId = e.detail.id;

                if (chartId != null) {
                    var currentChild = Polymer.dom(self).querySelector('[plot-id$="' + cId + '"]');
                    currentChild.set("_hideLoader", false);
                    this._updateChart(chartId);
                }
                self._initializeRemoveDialog();

            },

            /**
             * Generates a unique chart ID
             * 
             * @return {string}
             */
            _generatePlotId: function() {
                var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var result = '';
                var size = 7;

                for (var i = 0; i < size; ++i) {
                    result += chars[Math.round(Math.random() * (chars.length - 1))];
                }
                return 'epiviz-' + result;
            },

            /**
             * ChartLocation/RangeChange event handler.
             */
            _rangeChanged: function() {

                var self = this;

                if(self.measurements) {
                    var numChildren = self.getEffectiveChildren().length;
                    if(numChildren > 0) {self.set('_isEmpty', true);}
                    for (var index = 0; index < numChildren; index++) {
                        var currentChild = self.getEffectiveChildren()[index];
                        if(currentChild == undefined || currentChild.plotId == undefined) {return ;}
                        currentChild.range = self.range;
                        // self._updateChart(currentChild.plotId);  
                        self._getElementData(currentChild, self, self.measurements);
                    }
                }
            },

            /* callback function after the element is attached to the DOM */
            attached: function() {
                var self = this;

                // if(!(self.start && self.end && self.seqInfo[self.chr])) {
                //     if(self.chr && self.seqInfo) {
                //         self.start = 0;
                //         self.end = self.seqInfo[self.chr].max;
                //     }
                // }
                $(this).find("#chartContainer").sortable({
                    delay: 150,
                    items: "> :not(epiviz-navigation)",
                });

                if(self.initializeRegions.length > 0) {
                    for(var i=0; i< self.initializeRegions.length; i++) {
                        var navElem = document.createElement("epiviz-navigation");
                        navElem.className = "charts";
                        if(Object.keys(self.initializeRegions[i]).indexOf("gene") != -1) {
                            navElem.gene = self.initializeRegions[i].gene;
                        }
                        else {
                            navElem.chr = self.initializeRegions[i].region.chr;
                            navElem.start = self.initializeRegions[i].region.start;
                            navElem.end = self.initializeRegions[i].region.end;
                        }
                        Polymer.dom(self).appendChild(navElem);
                    }
                }

                self._observer =
                    Polymer.dom(self.$.chartEnv).observeNodes(function(info) {
                        info.addedNodes.forEach(function(node) {
                            // self._updateChart(node.plotId);
                            node._parentContainer = self;
                            if(node.nodeName === "EPIVIZ-NAVIGATION") {
                                self._getElementSeqInfo(node, Polymer.dom(self));

                                self.push("navigationRegions", {"plotId": node.plotId, "range": node.range});

                                // if(node.collapsed) {
                                    var navChildren = node.getEffectiveChildren().length;
                                    for (var nindex = 0; nindex < navChildren; nindex++) {
                                        var currentNavChild = node.getEffectiveChildren()[nindex];
                                        currentNavChild._parentContainer = self;
                                        if(!currentNavChild.data) {
                                            self._getElementData(currentNavChild, self, self.measurements);
                                        }                                    
                                    }
                            }
                            else {
                                if(!node.data) {
                                    self._getElementData(node, self, self.measurements);
                                }
                            }

                            self.set('_isEmpty', true);
                        });

                        self.saveWorkspace();
                    });

                    self.$.addChart._parentContainer = self;
            },

            // created: function() {
            //     var self = this;
            // },

            /* callback function after the element is initialized & attached */
            ready: function() {
                // this.scopeSubtree(this, true);
                var self = this;

                self.plotId = self.plotId || self._generatePlotId();

                if(self.transformDataFunc) {
                    self.transformFunc = new Function('return ' + self.transformDataFunc);
                }
                else {
                    self.transformFunc = self.epivizToJSON;
                }

                // self._getElementSeqInfo(self, self);

                if(self.chr != "all") {
                    self._getElementSeqInfo(self, self);
                }

                if(self.workspace) {
                    self.loadWorkspace(self.workspace);
                }
                self._initializeAddDialog();
            }
        });
    </script>
</dom-module>